<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>带有 Play 框架和 Akka 的 WebSockets - Coding Man</title><meta name="Description" content="在本教程中，我们使用 Akka 演员和 Akka 流在 Play 框架中实现了 WebSocket。然后我们继续研究如何直接使用 Akka Actor，然后了解如何设置 Akka Streams 来处理 WebSocket 连接。在客户端，我们使用 JavaScript 来处理我们的 WebSocket 事件。最后，我们查看了一些可以使用的配置选项。"><meta property="og:title" content="带有 Play 框架和 Akka 的 WebSockets" />
<meta property="og:description" content="在本教程中，我们使用 Akka 演员和 Akka 流在 Play 框架中实现了 WebSocket。然后我们继续研究如何直接使用 Akka Actor，然后了解如何设置 Akka Streams 来处理 WebSocket 连接。在客户端，我们使用 JavaScript 来处理我们的 WebSocket 事件。最后，我们查看了一些可以使用的配置选项。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://itcodingman.github.io/akka_play_websockets/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-04-08T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-07-22T00:00:00+00:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="带有 Play 框架和 Akka 的 WebSockets"/>
<meta name="twitter:description" content="在本教程中，我们使用 Akka 演员和 Akka 流在 Play 框架中实现了 WebSocket。然后我们继续研究如何直接使用 Akka Actor，然后了解如何设置 Akka Streams 来处理 WebSocket 连接。在客户端，我们使用 JavaScript 来处理我们的 WebSocket 事件。最后，我们查看了一些可以使用的配置选项。"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2168947316195146"
     crossorigin="anonymous"></script><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://itcodingman.github.io/akka_play_websockets/" /><link rel="prev" href="http://itcodingman.github.io/akka_http/" /><link rel="next" href="http://itcodingman.github.io/akka_streams/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "带有 Play 框架和 Akka 的 WebSockets",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/itcodingman.github.io\/akka_play_websockets\/"
        },"genre": "posts","keywords": "Akka, Play, WebSockets","wordcount":  3644 ,
        "url": "http:\/\/itcodingman.github.io\/akka_play_websockets\/","datePublished": "2018-04-08T00:00:00+00:00","dateModified": "2022-07-22T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "codingman"
            },"description": "在本教程中，我们使用 Akka 演员和 Akka 流在 Play 框架中实现了 WebSocket。然后我们继续研究如何直接使用 Akka Actor，然后了解如何设置 Akka Streams 来处理 WebSocket 连接。在客户端，我们使用 JavaScript 来处理我们的 WebSocket 事件。最后，我们查看了一些可以使用的配置选项。"
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Coding Man"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/logo.jpg"
        data-srcset="/logo.jpg, /logo.jpg 1.5x, /logo.jpg 2x"
        data-sizes="auto"
        alt="/logo.jpg"
        title="/logo.jpg" />Coding Man</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 
										</a><a class="menu-item" href="/tags/"> 标签 
										</a><a class="menu-item" href="/categories/"> 分类 
										</a><a class="menu-item" href="/search/"><i class='fas fa-fw fa-search'></i> 搜索 
										</a>
										<div class="dropdown">
											<a href="javascript:void(0);" class="menu-item menu-more dropbtn" title="" > 链接 
											</a>
											<div class="menu-more-content dropdown-content"><a href="https://space.bilibili.com/499533333" title="" target="_blank" rel="noopener"> BiliBili </a><a href="https://www.youtube.com/c/itcodingman" title="" target="_blank" rel="noopener"> YouTube </a></div>
										</div>
									<span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Coding Man"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/logo.jpg"
        data-srcset="/logo.jpg, /logo.jpg 1.5x, /logo.jpg 2x"
        data-sizes="auto"
        alt="/logo.jpg"
        title="/logo.jpg" />Coding Man</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/"> 文章 
								</a><a class="menu-item" href="/tags/"> 标签 
								</a><a class="menu-item" href="/categories/"> 分类 
								</a><a class="menu-item" href="/search/"><i class='fas fa-fw fa-search'></i> 搜索 
								</a>
								<div class="dropdown">
									<a href="javascript:void(0);" class="menu-item menu-more dropbtn" title="" > 链接 
									</a>
									<div class="menu-more-content dropdown-content"><a href="https://space.bilibili.com/499533333" title="" target="_blank" rel="noopener"> BiliBili </a><a href="https://www.youtube.com/c/itcodingman" title="" target="_blank" rel="noopener"> YouTube </a></div>
								</div>
							<a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container">
                    <div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">带有 Play 框架和 Akka 的 WebSockets</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>codingman</a></span>&nbsp;<span class="post-category">included in <a href="/categories/java/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Java</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2018-04-08">2018-04-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;3644 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;8 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#21-设置-play-框架应用程序">2.1 设置 Play 框架应用程序</a></li>
        <li><a href="#22-添加必要的-javascript-文件">2.2. 添加必要的 JavaScript 文件</a></li>
        <li><a href="#23-设置-akka">2.3. 设置 Akka</a></li>
        <li><a href="#31-websocket-控制器方法">3.1 WebSocket 控制器方法</a></li>
        <li><a href="#32-routes文件">3.2. <em>routes</em>文件</a></li>
        <li><a href="#33-actor-实现">3.3. Actor 实现</a></li>
        <li><a href="#34-使用-akka-http-使用-rest-api">3.4. 使用 Akka HTTP 使用 Rest API</a></li>
        <li><a href="#41-控制器动作">4.1 控制器动作</a></li>
        <li><a href="#42-模板页面">4.2. 模板页面</a></li>
        <li><a href="#43-javascript-中的-websocket-事件处理程序">4.3. JavaScript 中的 WebSocket 事件处理程序</a></li>
        <li><a href="#44-运行和测试应用程序">4.4. 运行和测试应用程序</a></li>
        <li><a href="#61-处理-actor-终止">6.1 处理 Actor 终止</a></li>
        <li><a href="#62-手动终止-actor">6.2. 手动终止 Actor</a></li>
        <li><a href="#71-websocket-帧长度">7.1 WebSocket 帧长度</a></li>
        <li><a href="#72-连接空闲超时">7.2. 连接空闲超时</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><ol>
<li>概述</li>
</ol>
<hr>
<p>当我们希望我们的 Web 客户端与我们的服务器保持对话时，WebSockets 可能是一个有用的解决方案。<strong>WebSockets 保持持久的全双工连接。这使我们能够在服务器和客户端之间发送双向消息。</strong></p>
<p>在本教程中，我们将学习如何在<a href="/java-intro-to-the-play-framework" rel="">Play Framework中将 WebSockets</a> 与<a href="/akka-actors-java" rel="">Akka</a>一起使用。</p>
<ol start="2">
<li>设置</li>
</ol>
<hr>
<p>让我们设置一个简单的聊天应用程序。用户将向服务器发送消息，服务器将响应来自<a href="https://jsonplaceholder.typicode.com/" target="_blank" rel="noopener noreffer">JSONPlaceholder</a>的消息。</p>
<h3 id="21-设置-play-框架应用程序">2.1 设置 Play 框架应用程序</h3>
<p>我们将使用 Play 框架构建这个应用程序。</p>
<p>让我们按照<a href="/java-intro-to-the-play-framework#Play" rel="">Introduction to Play in Java</a> 中的说明设置和运行一个简单的 Play Framework 应用程序。</p>
<h3 id="22-添加必要的-javascript-文件">2.2. 添加必要的 JavaScript 文件</h3>
<p>此外，我们还需要使用 JavaScript 来编写客户端脚本。这将使我们能够接收从服务器推送的新消息。我们将为此使用<a href="https://code.jquery.com/" target="_blank" rel="noopener noreffer">jQuery</a>库。</p>
<p>让我们将 jQuery 添加到<em>app/views/</em> <em>index.scala.html</em>文件的底部：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;https://code.jquery.com/jquery-3.4.1.min.js&#34;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
</span></span></code></pre></div><h3 id="23-设置-akka">2.3. 设置 Akka</h3>
<p>最后，我们将使用 Akka 来处理服务器端的 WebSocket 连接。</p>
<p>让我们导航到<em>build.sbt</em>文件并添加依赖项。</p>
<p>我们需要添加 *<a href="https://search.maven.org/classic/#search%7Cgav%7C1%7Cg%3A%22com.typesafe.akka%22%20AND%20a%3A%22akka-actor_2.13%22" target="_blank" rel="noopener noreffer">as-actor</a>*和 *<a href="https://search.maven.org/classic/#search%7Cgav%7C1%7Cg%3A%22com.typesafe.akka%22%20AND%20a%3A%22akka-testkit_2.13%22" target="_blank" rel="noopener noreffer">as-testkit</a>*依赖项：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">&#34;com.typesafe.akka&#34;</span> <span class="o">%%</span> <span class="s">&#34;akka-actor&#34;</span> <span class="o">%</span> <span class="n">akkaVersion</span>
</span></span><span class="line"><span class="cl"><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">&#34;com.typesafe.akka&#34;</span> <span class="o">%%</span> <span class="s">&#34;akka-testkit&#34;</span> <span class="o">%</span> <span class="n">akkaVersion</span>
</span></span></code></pre></div><p>我们需要这些能够使用和测试 Akka 框架代码。</p>
<p>接下来，我们将使用 Akka 流。所以让我们添加*<a href="https://search.maven.org/classic/#search%7Cgav%7C1%7Cg%3A%22com.typesafe.akka%22%20AND%20a%3A%22akka-stream_2.13%22" target="_blank" rel="noopener noreffer">akka-stream</a>*依赖项：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">&#34;com.typesafe.akka&#34;</span> <span class="o">%%</span> <span class="s">&#34;akka-stream&#34;</span> <span class="o">%</span> <span class="n">akkaVersion</span>
</span></span></code></pre></div><p>最后，我们需要从 Akka actor 调用一个 rest 端点。为此，我们需要 *<a href="https://search.maven.org/classic/#search%7Cgav%7C1%7Cg%3A%22com.typesafe.akka%22%20AND%20a%3A%22akka-http_2.13%22" target="_blank" rel="noopener noreffer">akka-http</a>*依赖项。当我们这样做时，端点将返回我们必须反序列化的 JSON 数据，因此我们还需要添加<a href="https://search.maven.org/classic/#search%7Cgav%7C1%7Cg%3A%22com.typesafe.akka%22%20AND%20a%3A%22akka-http-jackson_2.13%22" target="_blank" rel="noopener noreffer"><em>akka-http-jackson</em></a>依赖项：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">&#34;com.typesafe.akka&#34;</span> <span class="o">%%</span> <span class="s">&#34;akka-http-jackson&#34;</span> <span class="o">%</span> <span class="n">akkaHttpVersion</span>
</span></span><span class="line"><span class="cl"><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">&#34;com.typesafe.akka&#34;</span> <span class="o">%%</span> <span class="s">&#34;akka-http&#34;</span> <span class="o">%</span> <span class="n">akkaHttpVersion</span>
</span></span></code></pre></div><p>现在我们都准备好了。让我们看看如何让 WebSockets 工作！</p>
<ol start="3">
<li>使用 Akka Actor 处理 WebSocket</li>
</ol>
<hr>
<p>**Play 的 WebSocket 处理机制是围绕 Akka 流构建的。**WebSocket 被建模为流。因此，传入的 WebSocket 消息被馈送到流中，流产生的消息被发送到客户端。</p>
<p>要使用 Actor 处理 WebSocket，我们需要将<em>ActorRef</em>转换为流的 Play 实用程序<em>ActorFlow</em>。这主要需要一些Java代码，稍加配置。</p>
<h3 id="31-websocket-控制器方法">3.1 WebSocket 控制器方法</h3>
<p>首先，我们需要一个<em>Materializer</em>实例。<strong>Materializer 是流执行引擎的工厂。</strong></p>
<p>我们需要将<em>ActorSystem</em>和<em>Materializer</em>注入控制器<em>app/controllers/HomeController.java</em>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">ActorSystem</span> <span class="n">actorSystem</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">Materializer</span> <span class="n">materializer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Inject</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">HomeController</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">ActorSystem</span> <span class="n">actorSystem</span><span class="o">,</span> <span class="n">Materializer</span> <span class="n">materializer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">actorSystem</span> <span class="o">=</span> <span class="n">actorSystem</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">materializer</span> <span class="o">=</span> <span class="n">materializer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>现在让我们添加一个套接字控制器方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">WebSocket</span> <span class="nf">socket</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">WebSocket</span><span class="o">.</span><span class="na">Json</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">acceptOrResult</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">createActorFlow</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>这里我们调用函数<em>acceptOrResult</em>，它接受请求头并返回一个future。返回的未来是处理 WebSocket 消息的流。</p>
<p>相反，我们可以拒绝请求并返回拒绝结果。</p>
<p>现在，让我们创建流程：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">F</span><span class="o">.</span><span class="na">Either</span><span class="o">&lt;</span><span class="n">Result</span><span class="o">,</span> <span class="n">Flow</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">,</span> <span class="n">JsonNode</span><span class="o">,</span> <span class="o">?&gt;&gt;&gt;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">createActorFlow</span><span class="o">(</span><span class="n">Http</span><span class="o">.</span><span class="na">RequestHeader</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">completedFuture</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">F</span><span class="o">.</span><span class="na">Either</span><span class="o">.</span><span class="na">Right</span><span class="o">(</span><span class="n">createFlowForActor</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Play Framework 中的 <em>F</em>类定义了一组函数式编程风格的助手。在这种情况下，我们使用<em>F.Either.Right</em>来接受连接并返回流。</p>
<p>假设我们想在客户端未通过身份验证时拒绝连接。</p>
<p>为此，我们可以检查会话中是否设置了用户名。如果不是，我们拒绝与 HTTP 403 Forbidden 的连接：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">F</span><span class="o">.</span><span class="na">Either</span><span class="o">&lt;</span><span class="n">Result</span><span class="o">,</span> <span class="n">Flow</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">,</span> <span class="n">JsonNode</span><span class="o">,</span> <span class="o">?&gt;&gt;&gt;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">createActorFlow2</span><span class="o">(</span><span class="n">Http</span><span class="o">.</span><span class="na">RequestHeader</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">completedFuture</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">request</span><span class="o">.</span><span class="na">session</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">getOptional</span><span class="o">(</span><span class="s">&#34;username&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">username</span> <span class="o">-&gt;</span> 
</span></span><span class="line"><span class="cl">        <span class="n">F</span><span class="o">.</span><span class="na">Either</span><span class="o">.&lt;</span><span class="n">Result</span><span class="o">,</span> <span class="n">Flow</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">,</span> <span class="n">JsonNode</span><span class="o">,</span> <span class="o">?&gt;&gt;</span><span class="n">Right</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">createFlowForActor</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">orElseGet</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">F</span><span class="o">.</span><span class="na">Either</span><span class="o">.</span><span class="na">Left</span><span class="o">(</span><span class="n">forbidden</span><span class="o">())));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>我们使用<em>F.Either.Left</em> 来拒绝连接，就像我们使用<em>F.Either.Right</em>提供流一样。</p>
<p>最后，我们将流程链接到将处理消息的参与者：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">Flow</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">,</span> <span class="n">JsonNode</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">createFlowForActor</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ActorFlow</span><span class="o">.</span><span class="na">actorRef</span><span class="o">(</span><span class="n">out</span> <span class="o">-&gt;</span> <span class="n">Messenger</span><span class="o">.</span><span class="na">props</span><span class="o">(</span><span class="n">out</span><span class="o">),</span> 
</span></span><span class="line"><span class="cl">      <span class="n">actorSystem</span><span class="o">,</span> <span class="n">materializer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p><strong>ActorFlow.actorRef创建了一个由 <em>Messenger</em> <em>actor</em>处理的流</strong>。</p>
<h3 id="32-routes文件">3.2. <em>routes</em>文件</h3>
<p>现在，让我们在<em>conf/routes</em>中添加控制器方法的<em>路由</em>定义：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">GET</span>  <span class="o">/</span>                    <span class="n">controllers</span><span class="o">.</span><span class="na">HomeController</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">request</span><span class="o">:</span> <span class="n">Request</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">GET</span>  <span class="o">/</span><span class="n">chat</span>                <span class="n">controllers</span><span class="o">.</span><span class="na">HomeController</span><span class="o">.</span><span class="na">socket</span>
</span></span><span class="line"><span class="cl"><span class="n">GET</span>  <span class="o">/</span><span class="n">chat</span><span class="o">/</span><span class="n">with</span><span class="o">/</span><span class="n">streams</span>   <span class="n">controllers</span><span class="o">.</span><span class="na">HomeController</span><span class="o">.</span><span class="na">akkaStreamsSocket</span>
</span></span><span class="line"><span class="cl"><span class="n">GET</span>  <span class="o">/</span><span class="n">assets</span><span class="o">/*</span><span class="n">file</span>        <span class="n">controllers</span><span class="o">.</span><span class="na">Assets</span><span class="o">.</span><span class="na">versioned</span><span class="o">(</span><span class="n">path</span><span class="o">=</span><span class="s">&#34;/public&#34;</span><span class="o">,</span> <span class="n">file</span><span class="o">:</span> <span class="n">Asset</span><span class="o">)</span>
</span></span></code></pre></div><p>这些路由定义将传入的 HTTP 请求映射到控制器操作方法，如<a href="/routing-in-play" rel="">Routing in Play Applications in Java 中</a>所述。</p>
<h3 id="33-actor-实现">3.3. Actor 实现</h3>
<p><strong>Actor 类最重要的部分是 <em>createReceive</em>方法</strong>，它决定了 Actor 可以处理哪些消息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Receive</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">JsonNode</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">onSendMessage</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">matchAny</span><span class="o">(</span><span class="n">o</span> <span class="o">-&gt;</span> <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Received unknown message: {}&#34;</span><span class="o">,</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p><em>Actor 会将与JsonNode</em>类 匹配的所有消息转发到<em>onSendMessage</em>处理程序方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">onSendMessage</span><span class="o">(</span><span class="n">JsonNode</span> <span class="n">jsonNode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">RequestDTO</span> <span class="n">requestDTO</span> <span class="o">=</span> <span class="n">MessageConverter</span><span class="o">.</span><span class="na">jsonNodeToRequest</span><span class="o">(</span><span class="n">jsonNode</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">requestDTO</span><span class="o">.</span><span class="na">getMessage</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//..
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">processMessage</span><span class="o">(</span><span class="n">requestDTO</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p><em>然后处理程序将使用processMessage</em>方法响应每条消息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">processMessage</span><span class="o">(</span><span class="n">RequestDTO</span> <span class="n">requestDTO</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">HttpResponse</span><span class="o">&gt;</span> <span class="n">responseFuture</span> <span class="o">=</span> <span class="n">getRandomMessage</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">responseFuture</span><span class="o">.</span><span class="na">thenCompose</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">consumeHttpResponse</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">thenAccept</span><span class="o">(</span><span class="n">messageDTO</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">MessageConverter</span><span class="o">.</span><span class="na">messageToJsonNode</span><span class="o">(</span><span class="n">messageDTO</span><span class="o">),</span> <span class="n">getSelf</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="34-使用-akka-http-使用-rest-api">3.4. 使用 Akka HTTP 使用 Rest API</h3>
<p>我们将向<a href="https://jsonplaceholder.typicode.com/posts/" target="_blank" rel="noopener noreffer">JSONPlaceholder Posts</a>的虚拟消息生成器发送 HTTP 请求。当响应到达时，我们通过写出将响应发送给客户<em>端</em>。</p>
<p>让我们有一个使用随机帖子 ID 调用端点的方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">HttpResponse</span><span class="o">&gt;</span> <span class="nf">getRandomMessage</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">postId</span> <span class="o">=</span> <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">100</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Http</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">getContext</span><span class="o">().</span><span class="na">getSystem</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">singleRequest</span><span class="o">(</span><span class="n">HttpRequest</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;https://jsonplaceholder.typicode.com/posts/&#34;</span> <span class="o">+</span> <span class="n">postId</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>我们还在处理通过调用服务获得的<em>HttpResponse</em>以获得 JSON 响应：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">MessageDTO</span><span class="o">&gt;</span> <span class="nf">consumeHttpResponse</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">HttpResponse</span> <span class="n">httpResponse</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Materializer</span> <span class="n">materializer</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl">      <span class="n">Materializer</span><span class="o">.</span><span class="na">matFromSystem</span><span class="o">(</span><span class="n">getContext</span><span class="o">().</span><span class="na">getSystem</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Jackson</span><span class="o">.</span><span class="na">unmarshaller</span><span class="o">(</span><span class="n">MessageDTO</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">unmarshal</span><span class="o">(</span><span class="n">httpResponse</span><span class="o">.</span><span class="na">entity</span><span class="o">(),</span> <span class="n">materializer</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">messageDTO</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Received message: {}&#34;</span><span class="o">,</span> <span class="n">messageDTO</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">discardEntity</span><span class="o">(</span><span class="n">httpResponse</span><span class="o">,</span> <span class="n">materializer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="n">messageDTO</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p><em>MessageConverter</em>类是用于在 <em>JsonNode</em>和 DTO之间进行转换的 实用程序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">MessageDTO</span> <span class="nf">jsonNodeToMessage</span><span class="o">(</span><span class="n">JsonNode</span> <span class="n">jsonNode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectMapper</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">mapper</span><span class="o">.</span><span class="na">convertValue</span><span class="o">(</span><span class="n">jsonNode</span><span class="o">,</span> <span class="n">MessageDTO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>接下来，我们需要<a href="https://doc.akka.io/docs/akka-http/current/implications-of-streaming-http-entity.html" target="_blank" rel="noopener noreffer">丢弃实体</a>。如果实体对我们没有任何用途，则<em>discardEntityBytes便捷方法的目的是轻松丢弃实体。</em></p>
<p>让我们看看如何丢弃字节：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">discardEntity</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">HttpResponse</span> <span class="n">httpResponse</span><span class="o">,</span> <span class="n">Materializer</span> <span class="n">materializer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HttpMessage</span><span class="o">.</span><span class="na">DiscardedEntity</span> <span class="n">discarded</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl">      <span class="n">httpResponse</span><span class="o">.</span><span class="na">discardEntityBytes</span><span class="o">(</span><span class="n">materializer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">discarded</span><span class="o">.</span><span class="na">completionStage</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">done</span><span class="o">,</span> <span class="n">ex</span><span class="o">)</span> <span class="o">-&gt;</span> 
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Entity discarded completely!&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>现在已经完成了 WebSocket 的处理，让我们看看如何使用 HTML5 WebSockets 设置客户端。</p>
<ol start="4">
<li>设置 WebSocket 客户端</li>
</ol>
<hr>
<p>对于我们的客户，让我们构建一个简单的基于 Web 的聊天应用程序。</p>
<h3 id="41-控制器动作">4.1 控制器动作</h3>
<p>我们需要定义一个呈现索引页面的控制器动作。我们将把它放在控制器类<em>app.controllers.HomeController 中</em>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Result</span> <span class="nf">index</span><span class="o">(</span><span class="n">Http</span><span class="o">.</span><span class="na">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="n">routes</span><span class="o">.</span><span class="na">HomeController</span><span class="o">.</span><span class="na">socket</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">webSocketURL</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ok</span><span class="o">(</span><span class="n">views</span><span class="o">.</span><span class="na">html</span><span class="o">.</span><span class="na">index</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">url</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="42-模板页面">4.2. 模板页面</h3>
<p>现在，让我们转到<em>app/views/ndex.scala.html</em>页面并为接收到的消息添加一个容器和一个用于捕获新消息的表单：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;messageContent&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>F
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;messageInput&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;sendButton&#34;</span><span class="p">&gt;</span>Send<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>我们还需要通过在<em>app/views/index.scala.html</em>页面顶部声明此参数来传递 WebSocket 控制器操作的 URL：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">@(url: String)
</span></span></code></pre></div><h3 id="43-javascript-中的-websocket-事件处理程序">4.3. JavaScript 中的 WebSocket 事件处理程序</h3>
<p>现在，我们可以添加 JavaScript 来处理 WebSocket 事件。<em>为简单起见，我们将在app/views/index.scala.html</em>页面的底部添加 JavaScript 函数。</p>
<p>让我们声明事件处理程序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">webSocket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">messageInput</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">initWebSocket</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">initWebSocket</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">webSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s2">&#34;@url&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">webSocket</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="nx">onOpen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">webSocket</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="nx">onClose</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">webSocket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="nx">onMessage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">webSocket</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">onError</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>让我们自己添加处理程序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">onOpen</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">writeToScreen</span><span class="p">(</span><span class="s2">&#34;CONNECTED&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">onClose</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">writeToScreen</span><span class="p">(</span><span class="s2">&#34;DISCONNECTED&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">writeToScreen</span><span class="p">(</span><span class="s2">&#34;ERROR: &#34;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">evt</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">onMessage</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">receivedData</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">appendMessageToView</span><span class="p">(</span><span class="s2">&#34;Server&#34;</span><span class="p">,</span> <span class="nx">receivedData</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>然后，为了呈现输出，我们将使用函数<em>appendMessageToView</em>和<em>writeToScreen</em>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">appendMessageToView</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#messageContent&#34;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&#34;&lt;p&gt;&#34;</span> <span class="o">+</span> <span class="nx">title</span> <span class="o">+</span> <span class="s2">&#34;: &#34;</span> <span class="o">+</span> <span class="nx">message</span> <span class="o">+</span> <span class="s2">&#34;&lt;/p&gt;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">writeToScreen</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;New message: &#34;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="44-运行和测试应用程序">4.4. 运行和测试应用程序</h3>
<p>我们已准备好测试应用程序，让我们运行它：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> websockets
</span></span><span class="line"><span class="cl">sbt run
</span></span></code></pre></div><p>随着应用程序的运行，我们可以通过访问*<a href="http://localhost:9000" target="_blank" rel="noopener noreffer">http://localhost:9000</a>*与服务器聊天：</p>
<p><a href="/uploads/websocket_interactive_chat.png" rel=""></a>
每次我们输入消息并点击 <em>发送</em>时，服务器都会立即响应来自 JSON 占位符服务的一些<em>lorem ipsum 。</em></p>
<ol start="5">
<li>使用 Akka Streams 直接处理 WebSockets</li>
</ol>
<hr>
<p>如果我们正在处理来自源的事件流并将其发送到客户端，那么我们可以围绕 Akka 流进行建模。</p>
<p>让我们看看如何在服务器每两秒发送一次消息的示例中使用 Akka 流。</p>
<p>我们将从<em>HomeController</em>中的 WebSocket 操作开始：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">WebSocket</span> <span class="nf">akkaStreamsSocket</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">WebSocket</span><span class="o">.</span><span class="na">Json</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">request</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sink</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">in</span> <span class="o">=</span> <span class="n">Sink</span><span class="o">.</span><span class="na">foreach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">MessageDTO</span> <span class="n">messageDTO</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl">          <span class="k">new</span> <span class="n">MessageDTO</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">,</span> <span class="s">&#34;1&#34;</span><span class="o">,</span> <span class="s">&#34;Title&#34;</span><span class="o">,</span> <span class="s">&#34;Test Body&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Source</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">out</span> <span class="o">=</span> <span class="n">Source</span><span class="o">.</span><span class="na">tick</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="n">2</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">          <span class="n">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="n">2</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">          <span class="n">MessageConverter</span><span class="o">.</span><span class="na">messageToJsonNode</span><span class="o">(</span><span class="n">messageDTO</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Flow</span><span class="o">.</span><span class="na">fromSinkAndSource</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p><em>Source#</em> <em>tick</em>方法采用三个参数。第一个是处理第一个滴答之前的初始延迟，第二个是连续滴答之间的间隔。我们在上面的代码片段中将这两个值都设置为两秒。第三个参数是应在每次报价时返回的对象。</p>
<p>要查看此操作，我们需要修改<em>index</em>操作中的 URL 并使其指向<em>akkaStreamsSocket</em>端点：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="n">routes</span><span class="o">.</span><span class="na">HomeController</span><span class="o">.</span><span class="na">akkaStreamsSocket</span><span class="o">().</span><span class="na">webSocketURL</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span></code></pre></div><p>现在刷新页面，我们将每两秒看到一个新条目：</p>
<p><a href="/uploads/websocket_timed_chat.png" rel=""></a></p>
<ol start="6">
<li>终止 Actor</li>
</ol>
<hr>
<p>在某些时候，我们需要通过用户请求或超时来关闭聊天。</p>
<h3 id="61-处理-actor-终止">6.1 处理 Actor 终止</h3>
<p>我们如何检测 WebSocket 何时关闭？</p>
<p>当处理 WebSocket 的 actor 终止时，Play 将自动关闭 WebSocket。<em>所以我们可以通过实现Actor#postStop</em>方法来处理这种情况：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">postStop</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Messenger actor stopped at {}&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">OffsetDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">DateTimeFormatter</span><span class="o">.</span><span class="na">ISO_OFFSET_DATE_TIME</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="62-手动终止-actor">6.2. 手动终止 Actor</h3>
<p>此外，如果我们必须停止演员，我们可以向演员发送<em>PoisonPill</em>。在我们的示例应用程序中，我们应该能够处理“停止”请求。</p>
<p>让我们看看如何在 <em>onSendMessage</em>方法中做到这一点：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">onSendMessage</span><span class="o">(</span><span class="n">JsonNode</span> <span class="n">jsonNode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">RequestDTO</span> <span class="n">requestDTO</span> <span class="o">=</span> <span class="n">MessageConverter</span><span class="o">.</span><span class="na">jsonNodeToRequest</span><span class="o">(</span><span class="n">jsonNode</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">requestDTO</span><span class="o">.</span><span class="na">getMessage</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="o">(</span><span class="s">&#34;stop&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MessageDTO</span> <span class="n">messageDTO</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl">          <span class="n">createMessageDTO</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">,</span> <span class="s">&#34;1&#34;</span><span class="o">,</span> <span class="s">&#34;Stop&#34;</span><span class="o">,</span> <span class="s">&#34;Stopping actor&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">MessageConverter</span><span class="o">.</span><span class="na">messageToJsonNode</span><span class="o">(</span><span class="n">messageDTO</span><span class="o">),</span> <span class="n">getSelf</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">self</span><span class="o">().</span><span class="na">tell</span><span class="o">(</span><span class="n">PoisonPill</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(),</span> <span class="n">getSelf</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Actor received. {}&#34;</span><span class="o">,</span> <span class="n">requestDTO</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">processMessage</span><span class="o">(</span><span class="n">requestDTO</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>当我们收到一条消息时，我们会检查它是否是一个停止请求。如果是，我们发送 <em>PoisonPill</em>。否则，我们处理请求。</p>
<ol start="7">
<li>配置选项</li>
</ol>
<hr>
<p>我们可以根据如何处理 WebSocket 来配置几个选项。让我们看几个。</p>
<h3 id="71-websocket-帧长度">7.1 WebSocket 帧长度</h3>
<p>WebSocket 通信涉及数据帧的交换。</p>
<p>WebSocket 帧长度是可配置的。我们可以根据应用要求调整帧长度。</p>
<p>**配置较短的帧长度可能有助于减少使用长数据帧的拒绝服务攻击。**我们可以通过在 application.conf 中指定最大长度来更改应用程序的<em>帧长度</em>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">play.server.websocket.frame.maxLength = 64k
</span></span></code></pre></div><p>我们还可以通过将最大长度指定为命令行参数来设置此配置选项：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sbt -Dwebsocket.frame.maxLength<span class="o">=</span>64k run
</span></span></code></pre></div><h3 id="72-连接空闲超时">7.2. 连接空闲超时</h3>
<p>默认情况下，我们用来处理 WebSocket 的actor在一分钟后终止。**这是因为运行我们的应用程序的 Play 服务器的默认空闲超时时间为 60 秒。**这意味着所有在 60 秒内未收到请求的连接都会自动关闭。</p>
<p>我们可以通过配置选项来改变它。让我们转到我们的<em>application.conf</em>并将服务器更改为没有空闲超时：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">play.server.http.idleTimeout = &#34;infinite&#34;
</span></span></code></pre></div><p>或者我们可以将选项作为命令行参数传入：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sbt -Dhttp.idleTimeout<span class="o">=</span>infinite run
</span></span></code></pre></div><p>我们也可以通过 在 <em>build.sbt中指定**devSettings</em>来配置它。</p>
<p><strong><em>build.sbt</em>中指定的配置选项仅在开发中使用，它们将在生产中被忽略：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="nc">PlayKeys</span><span class="o">.</span><span class="n">devSettings</span> <span class="o">+=</span> <span class="s">&#34;play.server.http.idleTimeout&#34;</span> <span class="o">-&gt;</span> <span class="s">&#34;infinite&#34;</span>
</span></span></code></pre></div><p>如果我们重新运行应用程序，actor 不会终止。</p>
<p>我们可以将值更改为秒：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="nc">PlayKeys</span><span class="o">.</span><span class="n">devSettings</span> <span class="o">+=</span> <span class="s">&#34;play.server.http.idleTimeout&#34;</span> <span class="o">-&gt;</span> <span class="s">&#34;120 s&#34;</span>
</span></span></code></pre></div><p><a href="https://www.playframework.com/documentation/2.7.x/ConfigFile" target="_blank" rel="noopener noreffer">我们可以在 Play Framework 文档</a>中找到有关可用配置选项的更多信息。
&quot;</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-07-22</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://itcodingman.github.io/akka_play_websockets/" data-title="带有 Play 框架和 Akka 的 WebSockets" data-hashtags="Akka,Play,WebSockets"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://itcodingman.github.io/akka_play_websockets/" data-hashtag="Akka"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://itcodingman.github.io/akka_play_websockets/" data-title="带有 Play 框架和 Akka 的 WebSockets"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://itcodingman.github.io/akka_play_websockets/" data-title="带有 Play 框架和 Akka 的 WebSockets"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://itcodingman.github.io/akka_play_websockets/" data-title="带有 Play 框架和 Akka 的 WebSockets"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/akka/">Akka</a>,&nbsp;<a href="/tags/play/">Play</a>,&nbsp;<a href="/tags/websockets/">WebSockets</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/akka_http/" class="prev" rel="prev" title="Akka HTTP 简介"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Akka HTTP 简介</a>
            <a href="/akka_streams/" class="next" rel="next" title="Akka Streams 指南">Akka Streams 指南<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">codingman</a></span></div>
        </div>
    </footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-XH3B2JPQ1K', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-XH3B2JPQ1K" async></script></body>
</html>
