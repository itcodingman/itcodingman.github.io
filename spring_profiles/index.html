<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Spring 中的 Profiles - Coding Man</title><meta name="Description" content="在本文中，我们讨论了如何在 bean 上定义配置文件，以及如何在我们的应用程序中启用正确的配置文件。"><meta property="og:title" content="Spring 中的 Profiles" />
<meta property="og:description" content="在本文中，我们讨论了如何在 bean 上定义配置文件，以及如何在我们的应用程序中启用正确的配置文件。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://itcodingman.github.io/spring_profiles/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-09-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-07-20T00:00:00+00:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring 中的 Profiles"/>
<meta name="twitter:description" content="在本文中，我们讨论了如何在 bean 上定义配置文件，以及如何在我们的应用程序中启用正确的配置文件。"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2168947316195146"
     crossorigin="anonymous"></script><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://itcodingman.github.io/spring_profiles/" /><link rel="prev" href="http://itcodingman.github.io/spring_mvc_view_resolver_tutorial/" /><link rel="next" href="http://itcodingman.github.io/spring_qualifier_annotation/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Spring 中的 Profiles",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/itcodingman.github.io\/spring_profiles\/"
        },"genre": "posts","wordcount":  3733 ,
        "url": "http:\/\/itcodingman.github.io\/spring_profiles\/","datePublished": "2020-09-16T00:00:00+00:00","dateModified": "2022-07-20T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "codingman"
            },"description": "在本文中，我们讨论了如何在 bean 上定义配置文件，以及如何在我们的应用程序中启用正确的配置文件。"
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Coding Man"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/logo.jpg"
        data-srcset="/logo.jpg, /logo.jpg 1.5x, /logo.jpg 2x"
        data-sizes="auto"
        alt="/logo.jpg"
        title="/logo.jpg" />Coding Man</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 
										</a><a class="menu-item" href="/tags/"> 标签 
										</a><a class="menu-item" href="/categories/"> 分类 
										</a><a class="menu-item" href="/search/"><i class='fas fa-fw fa-search'></i> 搜索 
										</a>
										<div class="dropdown">
											<a href="javascript:void(0);" class="menu-item menu-more dropbtn" title="" > 链接 
											</a>
											<div class="menu-more-content dropdown-content"><a href="https://space.bilibili.com/499533333" title="" target="_blank" rel="noopener"> BiliBili </a><a href="https://www.youtube.com/c/itcodingman" title="" target="_blank" rel="noopener"> YouTube </a></div>
										</div>
									<span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Coding Man"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/logo.jpg"
        data-srcset="/logo.jpg, /logo.jpg 1.5x, /logo.jpg 2x"
        data-sizes="auto"
        alt="/logo.jpg"
        title="/logo.jpg" />Coding Man</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/"> 文章 
								</a><a class="menu-item" href="/tags/"> 标签 
								</a><a class="menu-item" href="/categories/"> 分类 
								</a><a class="menu-item" href="/search/"><i class='fas fa-fw fa-search'></i> 搜索 
								</a>
								<div class="dropdown">
									<a href="javascript:void(0);" class="menu-item menu-more dropbtn" title="" > 链接 
									</a>
									<div class="menu-more-content dropdown-content"><a href="https://space.bilibili.com/499533333" title="" target="_blank" rel="noopener"> BiliBili </a><a href="https://www.youtube.com/c/itcodingman" title="" target="_blank" rel="noopener"> YouTube </a></div>
								</div>
							<a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container">
                    <div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Spring 中的 Profiles</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>codingman</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2020-09-16">2020-09-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;3733 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;8 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-概述"><strong>1. 概述</strong></a></li>
    <li><a href="#2-在-bean-上使用profile"><strong>2. 在 Bean 上使用@Profile</strong></a></li>
    <li><a href="#3-在-xml-中声明配置文件"><strong>3. 在 XML 中声明配置文件</strong></a></li>
    <li><a href="#4设置配置文件"><strong>4.设置配置文件</strong></a>
      <ul>
        <li><a href="#41-通过webapplicationinitializer接口以编程方式"><strong>4.1 通过WebApplicationInitializer接口以编程方式</strong></a></li>
        <li><a href="#42-通过configurableenvironment以编程方式"><strong>4.2 通过ConfigurableEnvironment以编程方式</strong></a></li>
        <li><a href="#43-webxml中的上下文参数"><strong>4.3 web.xml中的上下文参数</strong></a></li>
        <li><a href="#44-jvm-系统参数"><strong>4.4 JVM 系统参数</strong></a></li>
        <li><a href="#45-环境变量"><strong>4.5 环境变量</strong></a></li>
        <li><a href="#46-maven-简介"><strong>4.6 Maven 简介</strong></a></li>
        <li><a href="#47-测试中的activeprofile"><strong>4.7. 测试中的@ActiveProfile</strong></a></li>
      </ul>
    </li>
    <li><a href="#5-默认配置文件"><strong>5. 默认配置文件</strong></a></li>
    <li><a href="#6-获取活跃的profile"><strong>6. 获取活跃的Profile</strong></a>
      <ul>
        <li><a href="#61-使用environment">6.1 使用<em>Environment</em></a></li>
        <li><a href="#62-使用springactiveprofile">6.2 使用<em>spring.active.profile</em></a></li>
      </ul>
    </li>
    <li><a href="#7-示例使用配置文件分离数据源配置"><strong>7. 示例：使用配置文件分离数据源配置</strong></a></li>
    <li><a href="#8-spring-boot-中的配置文件"><strong>8. Spring Boot 中的配置文件</strong></a>
      <ul>
        <li><a href="#81-激活或设置配置文件">8.1 激活或设置配置文件</a></li>
        <li><a href="#82-配置文件特定的属性文件">8.2 配置文件特定的属性文件</a></li>
        <li><a href="#83-多文档文件">8.3 多文档文件</a></li>
        <li><a href="#84-配置文件组">8.4 配置文件组</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="1-概述"><strong>1. 概述</strong></h2>
<p>在本教程中，我们将重点介绍 Spring 中的 Profiles。</p>
<p>配置文件是框架的核心特性——<strong>允许我们将 bean 映射到不同的配置文件</strong>——例如<em>dev</em>、<em>test</em>和<em>prod</em>。</p>
<p>然后，我们可以在不同的环境中激活不同的配置文件以仅引导我们需要的 bean。</p>
<h2 id="2-在-bean-上使用profile"><strong>2. 在 Bean 上使用@Profile</strong></h2>
<p>让我们从简单的开始，看看我们如何让一个 bean 属于一个特定的配置文件。<em><em>我们使用</em>@Profile*注释——我们将 bean 映射到那个特定的配置文件</em>*；注释仅采用一个（或多个）配置文件的名称。</p>
<p>考虑一个基本场景：我们有一个 bean，它应该只在开发期间处于活动状态，而不是在生产中部署。</p>
<p><em>我们使用开发</em>配置文件注释该 bean ，它只会在开发期间出现在容器中。在生产中，<em>开发人员</em>根本不会处于活动状态：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Profile</span><span class="o">(</span><span class="s">&#34;dev&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DevDatasourceConfig</span>
</span></span></code></pre></div><p>作为一个快速的旁注，配置文件名称也可以使用 NOT 运算符作为前缀，例如*!dev*，以将它们从配置文件中排除。</p>
<p>在示例中，仅当<em>dev</em> 配置文件未激活时才会激活组件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Profile</span><span class="o">(</span><span class="s">&#34;!dev&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DevDatasourceConfig</span>
</span></span></code></pre></div><h2 id="3-在-xml-中声明配置文件"><strong>3. 在 XML 中声明配置文件</strong></h2>
<p>配置文件也可以在 XML 中配置。&lt; <em>beans&gt;<em>标签有一个</em>profile</em>属性，它采用逗号分隔的适用配置文件的值：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;beans</span> <span class="na">profile=</span><span class="s">&#34;dev&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;devDatasourceConfig&#34;</span> 
</span></span><span class="line"><span class="cl">      <span class="na">class=</span><span class="s">&#34;org.codingman.profiles.DevDatasourceConfig&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/beans&gt;</span>
</span></span></code></pre></div><h2 id="4设置配置文件"><strong>4.设置配置文件</strong></h2>
<p>下一步是激活和设置配置文件，以便在容器中注册相应的 bean。</p>
<p>这可以通过多种方式完成，我们将在以下部分中进行探讨。</p>
<h3 id="41-通过webapplicationinitializer接口以编程方式"><strong>4.1 通过WebApplicationInitializer接口以编程方式</strong></h3>
<p>在 Web 应用程序中，<em>WebApplicationInitializer</em>可用于以编程方式配置<em>ServletContext</em>。</p>
<p>它也是以编程方式设置我们的活动配置文件的非常方便的位置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyWebApplicationInitializer</span> 
</span></span><span class="line"><span class="cl">  <span class="kd">implements</span> <span class="n">WebApplicationInitializer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="n">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="n">servletContext</span><span class="o">.</span><span class="na">setInitParameter</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;spring.profiles.active&#34;</span><span class="o">,</span> <span class="s">&#34;dev&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="42-通过configurableenvironment以编程方式"><strong>4.2 通过ConfigurableEnvironment以编程方式</strong></h3>
<p>我们还可以直接在环境中设置配置文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">ConfigurableEnvironment</span> <span class="n">env</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">env</span><span class="o">.</span><span class="na">setActiveProfiles</span><span class="o">(</span><span class="s">&#34;someProfile&#34;</span><span class="o">);</span>
</span></span></code></pre></div><h3 id="43-webxml中的上下文参数"><strong>4.3 web.xml中的上下文参数</strong></h3>
<p>同样，我们可以使用上下文参数在 Web 应用程序的<em>web.xml文件中定义活动配置文件：</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;context-param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;param-value&gt;</span>/WEB-INF/app-config.xml<span class="nt">&lt;/param-value&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/context-param&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;context-param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;param-name&gt;</span>spring.profiles.active<span class="nt">&lt;/param-name&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;param-value&gt;</span>dev<span class="nt">&lt;/param-value&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/context-param&gt;</span>
</span></span></code></pre></div><h3 id="44-jvm-系统参数"><strong>4.4 JVM 系统参数</strong></h3>
<p>配置文件名称也可以通过 JVM 系统参数传入。这些配置文件将在应用程序启动期间激活：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">-Dspring.profiles.active<span class="o">=</span>dev
</span></span></code></pre></div><h3 id="45-环境变量"><strong>4.5 环境变量</strong></h3>
<p>在 Unix 环境中，<strong>配置文件也可以通过环境变量激活</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">spring_profiles_active</span><span class="o">=</span>dev
</span></span></code></pre></div><h3 id="46-maven-简介"><strong>4.6 Maven 简介</strong></h3>
<p>Spring 配置文件也可以通过 Maven 配置文件激活，通过<strong>指定spring.profiles.active 配置属性</strong>。</p>
<p>在每个 Maven 配置文件中，我们可以设置一个<em>spring.profiles.active</em>属性：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;profiles&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;profile&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;id&gt;</span>dev<span class="nt">&lt;/id&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;activation&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;activeByDefault&gt;</span>true<span class="nt">&lt;/activeByDefault&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/activation&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;spring.profiles.active&gt;</span>dev<span class="nt">&lt;/spring.profiles.active&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/profile&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;profile&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;id&gt;</span>prod<span class="nt">&lt;/id&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;spring.profiles.active&gt;</span>prod<span class="nt">&lt;/spring.profiles.active&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/profile&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/profiles&gt;</span>
</span></span></code></pre></div><p><em><em>它的值将用于替换 application.properties 中的</em>@spring.profiles.active@</em> 占位符：**</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">spring.profiles.active=@spring.profiles.active@
</span></span></code></pre></div><p>现在我们需要在<em>pom.xml</em>中启用资源过滤：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;build&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;resources&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;resource&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;directory&gt;</span>src/main/resources<span class="nt">&lt;/directory&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;filtering&gt;</span>true<span class="nt">&lt;/filtering&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/resource&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/resources&gt;</span>
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/build&gt;</span>
</span></span></code></pre></div><p>并附加一个*-P*参数来切换将应用哪个 Maven 配置文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mvn clean package -Pprod
</span></span></code></pre></div><p>此命令将为<em>prod</em>配置文件打包应用程序。它还 在此应用程序运行时应用<em>spring.profiles.active</em> 值<em>prod</em> 。</p>
<h3 id="47-测试中的activeprofile"><strong>4.7. 测试中的@ActiveProfile</strong></h3>
<p>测试可以很容易地使用*@ActiveProfile*注释指定哪些配置文件处于活动状态以启用特定配置文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ActiveProfiles</span><span class="o">(</span><span class="s">&#34;dev&#34;</span><span class="o">)</span>
</span></span></code></pre></div><p>到目前为止，我们已经研究了多种激活配置文件的方法。现在让我们看看哪个优先级高于另一个，如果我们使用多个优先级会发生什么，从最高到最低优先级：</p>
<ol>
<li><em>web.xml</em>中的上下文参数</li>
<li><em>WebApplicationInitializer</em></li>
<li>JVM 系统参数</li>
<li>环境变量</li>
<li>Maven 简介</li>
</ol>
<h2 id="5-默认配置文件"><strong>5. 默认配置文件</strong></h2>
<p>任何未指定配置文件的 bean 都属于<em>默认</em> 配置文件。</p>
<p>Spring 还提供了一种在没有其他配置文件处于活动状态时设置默认配置文件的方法——通过使用<em>spring.profiles.default</em> 属性。</p>
<h2 id="6-获取活跃的profile"><strong>6. 获取活跃的Profile</strong></h2>
<p>Spring 的活动配置文件驱动*@Profile*注释的行为以启用/禁用 bean。但是，我们也可能希望以编程方式访问活动配置文件列表。</p>
<p>我们有两种方法可以做到这一点，<strong>使用<em>Environment</em>或<em>spring.active.profile</em>。</strong></p>
<h3 id="61-使用environment">6.1 使用<em>Environment</em></h3>
<p>我们可以通过注入<em>Environment</em>对象来访问活动配置文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProfileManager</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Environment</span> <span class="n">environment</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">getActiveProfiles</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">profileName</span> <span class="o">:</span> <span class="n">environment</span><span class="o">.</span><span class="na">getActiveProfiles</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Currently active profile - &#34;</span> <span class="o">+</span> <span class="n">profileName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>  
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="62-使用springactiveprofile">6.2 使用<em>spring.active.profile</em></h3>
<p>或者，我们可以通过注入属性 <em>spring.profiles.active</em>来访问配置文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${spring.profiles.active}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">String</span> <span class="n">activeProfile</span><span class="o">;</span>
</span></span></code></pre></div><p>在这里，我们的<em>activeProfile</em> 变量**将包含当前活动的配置文件的名称，**如果有多个，它将包含用逗号分隔的名称。</p>
<p>但是，我们应该**考虑如果根本没有活动配置文件会发生什么。**使用我们上面的代码，缺少活动配置文件会阻止创建应用程序上下文。由于缺少用于注入变量的占位符，这将导致<em>IllegalArgumentException 。</em></p>
<p>为了避免这种情况，我们可以<strong>定义一个默认值</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${spring.profiles.active:}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">String</span> <span class="n">activeProfile</span><span class="o">;</span>
</span></span></code></pre></div><p>现在，如果没有激活的配置文件，我们的<em>activeProfile</em>将只包含一个空字符串。</p>
<p>如果我们想像前面的例子一样访问它们的列表，我们可以通过<a href="/java-split-string" rel="">拆分</a><em>activeProfile</em>变量来实现：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProfileManager</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${spring.profiles.active:}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">activeProfiles</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getActiveProfiles</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">profileName</span> <span class="o">:</span> <span class="n">activeProfiles</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Currently active profile - &#34;</span> <span class="o">+</span> <span class="n">profileName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="7-示例使用配置文件分离数据源配置"><strong>7. 示例：使用配置文件分离数据源配置</strong></h2>
<p>既然基础知识已经结束，让我们看一个真实的例子。</p>
<p>考虑一个场景，<strong>我们必须为开发和生产环境维护数据源配置</strong>。</p>
<p>让我们创建一个需要由两个数据源实现实现的通用接口<em>DatasourceConfig</em> ：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DatasourceConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>下面是开发环境的配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Profile</span><span class="o">(</span><span class="s">&#34;dev&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DevDatasourceConfig</span> <span class="kd">implements</span> <span class="n">DatasourceConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Setting up datasource for DEV environment. &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>以及生产环境的配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Profile</span><span class="o">(</span><span class="s">&#34;production&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductionDatasourceConfig</span> <span class="kd">implements</span> <span class="n">DatasourceConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Setting up datasource for PRODUCTION environment. &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>现在让我们创建一个测试并注入我们的 DatasourceConfig 接口；根据活动配置文件，Spring 将注入<em>DevDatasourceConfig</em>或<em>ProductionDatasourceConfig</em> bean：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringProfilesWithMavenPropertiesIntegrationTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="n">DatasourceConfig</span> <span class="n">datasourceConfig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setupDatasource</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">datasourceConfig</span><span class="o">.</span><span class="na">setup</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>当<em>dev</em> 配置文件处于活动状态时，Spring 注入<em>DevDatasourceConfig</em>对象，然后调用*setup()*方法时，输出如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">Setting up datasource for DEV environment.
</span></span></code></pre></div><h2 id="8-spring-boot-中的配置文件"><strong>8. Spring Boot 中的配置文件</strong></h2>
<p>Spring Boot 支持到目前为止列出的所有配置文件配置，并具有一些附加功能。</p>
<h3 id="81-激活或设置配置文件">8.1 激活或设置配置文件</h3>
<p>第 4 节中介绍的初始化参数<em>spring.profiles.active</em>也可以设置为 Spring Boot 中的属性，以定义当前活动的配置文件。这是 Spring Boot 将自动获取的标准属性：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">spring.profiles.active=dev
</span></span></code></pre></div><p>但是，从 Spring Boot 2.4 开始，此属性不能与<em>spring.config.activate.on-profile</em>结合使用，因为这可能会引发<em>ConfigDataException</em> <em>（</em> 即<em>InvalidConfigDataPropertyException</em>或InactiveConfigDataAccessException <em>）</em>。</p>
<p>要以编程方式设置配置文件，我们还可以使用<em>SpringApplication</em>类：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">SpringApplication</span><span class="o">.</span><span class="na">setAdditionalProfiles</span><span class="o">(</span><span class="s">&#34;dev&#34;</span><span class="o">);</span>
</span></span></code></pre></div><p>要在 Spring Boot 中使用 Maven 设置配置文件，我们可以 在<em>pom.xm</em> <em>l中**的 spring-boot-maven-plugin</em>下指定配置文件名称：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;plugins&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;configuration&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;profiles&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;profile&gt;</span>dev<span class="nt">&lt;/profile&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/profiles&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/configuration&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/plugins&gt;</span>
</span></span></code></pre></div><p>并执行 Spring Boot 特定的 Maven 目标：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mvn spring-boot:run
</span></span></code></pre></div><h3 id="82-配置文件特定的属性文件">8.2 配置文件特定的属性文件</h3>
<p>但是，Spring Boot 带来的最重要的配置文件相关功能是**配置文件特定的属性文件。**这些必须以<em>application-{profile}.properties</em>格式命名。</p>
<p>Spring Boot 将自动为所有配置文件加载<em>application.properties</em>文件中的属性，并且仅为指定配置文件加载特定于配置文件的*.properties文件中的属性。*</p>
<p>例如，我们可以使用名为<em>application-dev.properties</em>和<em>application-production.properties</em>的两个文件为<em>dev</em>和<em>production</em>配置文件配置不同的数据源：</p>
<p>在<em>application-production.properties</em>文件中，我们可以设置一个<em>MySql</em>数据源：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
</span></span><span class="line"><span class="cl">spring.datasource.url=jdbc:mysql://localhost:3306/db
</span></span><span class="line"><span class="cl">spring.datasource.username=root
</span></span><span class="line"><span class="cl">spring.datasource.password=root
</span></span></code></pre></div><p>然后我们可以在<em>application-dev.properties</em>文件中为<em>dev</em>配置文件配置相同的属性，以使用内存<em>H2</em>数据库：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">spring.datasource.driver-class-name=org.h2.Driver
</span></span><span class="line"><span class="cl">spring.datasource.url=jdbc:h2:mem:db;DB_CLOSE_DELAY=-1
</span></span><span class="line"><span class="cl">spring.datasource.username=sa
</span></span><span class="line"><span class="cl">spring.datasource.password=sa
</span></span></code></pre></div><p>这样，我们就可以轻松地为不同的环境提供不同的配置。</p>
<p>在 Spring Boot 2.4 之前，可以从特定于配置文件的文档中激活配置文件。但情况已不再如此；对于更高版本， 在这些情况下，框架将再次抛出<em>InvalidConfigDataPropertyException</em>或 <em>InactiveConfigDataAccessException 。</em></p>
<h3 id="83-多文档文件">8.3 多文档文件</h3>
<p>为了进一步简化为不同环境定义属性，我们甚至可以将所有属性合并到同一个文件中，并使用分隔符来指示配置文件。</p>
<p>从 2.4 版本开始，除了之前支持的<a href="/spring-yaml" rel="">YAML</a>之外，Spring Boot 还扩展了对属性文件的多文档文件的支持。所以现在，<strong>我们可以在同一个<em>application.properties</em>中指定<em>dev</em>和<em>production</em>属性</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">my.prop=used-always-in-all-profiles
</span></span><span class="line"><span class="cl">#---
</span></span><span class="line"><span class="cl">spring.config.activate.on-profile=dev
</span></span><span class="line"><span class="cl">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
</span></span><span class="line"><span class="cl">spring.datasource.url=jdbc:mysql://localhost:3306/db
</span></span><span class="line"><span class="cl">spring.datasource.username=root
</span></span><span class="line"><span class="cl">spring.datasource.password=root
</span></span><span class="line"><span class="cl">#---
</span></span><span class="line"><span class="cl">spring.config.activate.on-profile=production
</span></span><span class="line"><span class="cl">spring.datasource.driver-class-name=org.h2.Driver
</span></span><span class="line"><span class="cl">spring.datasource.url=jdbc:h2:mem:db;DB_CLOSE_DELAY=-1
</span></span><span class="line"><span class="cl">spring.datasource.username=sa
</span></span><span class="line"><span class="cl">spring.datasource.password=sa
</span></span></code></pre></div><p>此文件由 Spring Boot 按从上到下的顺序读取。也就是说，如果某个属性，比如<em>my.prop</em>，在上述示例的末尾再次出现，则将考虑最后的值。</p>
<h3 id="84-配置文件组">8.4 配置文件组</h3>
<p>Boot 2.4 中添加的另一个功能是配置文件组。顾名思义，<strong>它允许我们将相似的配置文件组合在一起</strong>。</p>
<p>让我们考虑一个用例，其中我们有多个用于生产环境的配置文件。比如说，一个用于数据库的<em>proddb和一个用于</em>生产<em>环境中调度程序的</em>prodquartz 。*</p>
<p>要通过我们的<em>application.properties</em>文件一次性启用这些配置文件，我们可以指定：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">spring.profiles.group.production=proddb,prodquartz
</span></span></code></pre></div><p>因此，激活<em>production</em>配置文件也将激活<em>proddb</em>和<em>prodquartz</em>。
&quot;</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-07-20</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://itcodingman.github.io/spring_profiles/" data-title="Spring 中的 Profiles"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://itcodingman.github.io/spring_profiles/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://itcodingman.github.io/spring_profiles/" data-title="Spring 中的 Profiles"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://itcodingman.github.io/spring_profiles/" data-title="Spring 中的 Profiles"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://itcodingman.github.io/spring_profiles/" data-title="Spring 中的 Profiles"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/spring_mvc_view_resolver_tutorial/" class="prev" rel="prev" title="Spring MVC 中的 ViewResolver 指南"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Spring MVC 中的 ViewResolver 指南</a>
            <a href="/spring_qualifier_annotation/" class="next" rel="next" title="Spring @Qualifier 注解">Spring @Qualifier 注解<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">codingman</a></span></div>
        </div>
    </footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-XH3B2JPQ1K', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-XH3B2JPQ1K" async></script></body>
</html>
