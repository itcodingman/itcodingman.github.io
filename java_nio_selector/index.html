<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Java NIO 选择器简介 - Coding Man</title><meta name="Description" content="在本文中，我们介绍了 Java NIO Selector 组件的基本用法。"><meta property="og:title" content="Java NIO 选择器简介" />
<meta property="og:description" content="在本文中，我们介绍了 Java NIO Selector 组件的基本用法。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://itcodingman.github.io/java_nio_selector/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-07-26T00:00:00+00:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Java NIO 选择器简介"/>
<meta name="twitter:description" content="在本文中，我们介绍了 Java NIO Selector 组件的基本用法。"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2168947316195146"
     crossorigin="anonymous"></script><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://itcodingman.github.io/java_nio_selector/" /><link rel="prev" href="http://itcodingman.github.io/java_nio2_path/" /><link rel="next" href="http://itcodingman.github.io/java_nio2_async_file_channel/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Java NIO 选择器简介",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/itcodingman.github.io\/java_nio_selector\/"
        },"genre": "posts","keywords": "Java IO, Java NIO","wordcount":  4211 ,
        "url": "http:\/\/itcodingman.github.io\/java_nio_selector\/","datePublished": "2022-07-06T00:00:00+00:00","dateModified": "2022-07-26T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "codingman"
            },"description": "在本文中，我们介绍了 Java NIO Selector 组件的基本用法。"
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Coding Man"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/logo.jpg"
        data-srcset="/logo.jpg, /logo.jpg 1.5x, /logo.jpg 2x"
        data-sizes="auto"
        alt="/logo.jpg"
        title="/logo.jpg" />Coding Man</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 
										</a><a class="menu-item" href="/tags/"> 标签 
										</a><a class="menu-item" href="/categories/"> 分类 
										</a><a class="menu-item" href="/search/"><i class='fas fa-fw fa-search'></i> 搜索 
										</a>
										<div class="dropdown">
											<a href="javascript:void(0);" class="menu-item menu-more dropbtn" title="" > 链接 
											</a>
											<div class="menu-more-content dropdown-content"><a href="https://space.bilibili.com/499533333" title="" target="_blank" rel="noopener"> BiliBili </a><a href="https://www.youtube.com/c/itcodingman" title="" target="_blank" rel="noopener"> YouTube </a></div>
										</div>
									<span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Coding Man"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/logo.jpg"
        data-srcset="/logo.jpg, /logo.jpg 1.5x, /logo.jpg 2x"
        data-sizes="auto"
        alt="/logo.jpg"
        title="/logo.jpg" />Coding Man</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/"> 文章 
								</a><a class="menu-item" href="/tags/"> 标签 
								</a><a class="menu-item" href="/categories/"> 分类 
								</a><a class="menu-item" href="/search/"><i class='fas fa-fw fa-search'></i> 搜索 
								</a>
								<div class="dropdown">
									<a href="javascript:void(0);" class="menu-item menu-more dropbtn" title="" > 链接 
									</a>
									<div class="menu-more-content dropdown-content"><a href="https://space.bilibili.com/499533333" title="" target="_blank" rel="noopener"> BiliBili </a><a href="https://www.youtube.com/c/itcodingman" title="" target="_blank" rel="noopener"> YouTube </a></div>
								</div>
							<a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container">
                    <div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Java NIO 选择器简介</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>codingman</a></span>&nbsp;<span class="post-category">included in <a href="/categories/java/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Java</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-07-06">2022-07-06</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;4211 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;9 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-概述"><strong>1. 概述</strong></a></li>
    <li><a href="#2-为什么使用选择器"><strong>2. 为什么使用选择器？</strong></a></li>
    <li><a href="#3-设置"><strong>3. 设置</strong></a></li>
    <li><a href="#4-创建selector"><strong>4. 创建Selector</strong></a></li>
    <li><a href="#5-注册可选频道"><strong>5. 注册可选频道</strong></a></li>
    <li><a href="#6-selectionkey对象"><strong>6. <em>SelectionKey</em>对象</strong></a>
      <ul>
        <li><a href="#61-interestset"><strong>6.1 interestSet</strong></a></li>
        <li><a href="#62-selectionkey"><strong>6.2. selectionKey</strong></a></li>
        <li><a href="#63-channel"><strong>6.3. Channel</strong></a></li>
        <li><a href="#64-selector"><strong>6.4. Selector</strong></a></li>
        <li><a href="#65-附加对象"><strong>6.5 附加对象</strong></a></li>
      </ul>
    </li>
    <li><a href="#7-频道键选择"><strong>7. 频道键选择</strong></a></li>
    <li><a href="#8-完整示例"><strong>8. 完整示例</strong></a>
      <ul>
        <li><a href="#81-服务器"><strong>8.1 服务器</strong></a></li>
        <li><a href="#82-客户端"><strong>8.2. 客户端</strong></a></li>
        <li><a href="#83-测试"><strong>8.3. 测试</strong></a></li>
      </ul>
    </li>
    <li><a href="#9-selectorwakeup">9. <em>selector.wakeup()</em></a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="1-概述"><strong>1. 概述</strong></h2>
<p>在本文中，我们将探讨 Java NIO 的<em>Selector</em>组件的介绍部分。</p>
<p>选择器提供了一种机制，用于监视一个或多个 NIO 通道并识别一个或多个何时可用于数据传输。</p>
<p>这样，<strong>单个线程可用于管理多个通道</strong>，从而管理多个网络连接。</p>
<h2 id="2-为什么使用选择器"><strong>2. 为什么使用选择器？</strong></h2>
<p>使用选择器，我们可以使用一个线程而不是多个线程来管理多个通道。<strong>线程之间的上下文切换对于操作系统来说代价高昂</strong>，此外，<strong>每个线程都会占用内存。</strong></p>
<p>因此，我们使用的线程越少越好。但是，重要的是要记住，<strong>现代操作系统和 CPU 在多任务处理方面不断进步</strong>，因此多线程的开销会随着时间的推移而不断减少。</p>
<p>在这里，我们将讨论如何使用选择器在单个线程中处理多个通道。</p>
<p>另请注意，选择器不仅可以帮助您读取数据；还可以帮助您读取数据。他们还可以侦听传入的网络连接并通过慢速通道写入数据。</p>
<h2 id="3-设置"><strong>3. 设置</strong></h2>
<p>要使用选择器，我们不需要任何特殊设置。我们需要的所有类都在核心<em>java.nio</em>包中，我们只需要导入我们需要的。</p>
<p>之后，我们可以使用选择器对象注册多个通道。当任何通道上发生 I/O 活动时，选择器会通知我们。这就是我们可以在单个线程上从大量数据源中读取数据的方式。</p>
<p><em>我们向选择器注册的任何通道都必须是SelectableChannel</em>的子类。这些是一种特殊类型的通道，可以置于非阻塞模式。</p>
<h2 id="4-创建selector"><strong>4. 创建Selector</strong></h2>
<p>可以通过调用<em>Selector</em>类的静态<em>open</em>方法来创建选择器，该方法将使用系统的默认选择器提供程序来创建新的选择器：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="n">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
</span></span></code></pre></div><h2 id="5-注册可选频道"><strong>5. 注册可选频道</strong></h2>
<p>为了让选择器监控任何通道，我们必须向选择器注册这些通道。我们通过调用可选通道的<em>注册方法来做到这一点。</em></p>
<p>但是在使用选择器注册通道之前，它必须处于非阻塞模式：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">channel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
</span></span></code></pre></div><p>这意味着我们不能将<em>FileChannel</em>与选择器一起使用，因为它们不能像我们使用套接字通道那样切换到非阻塞模式。</p>
<p>第一个参数是我们之前创建的<em>Selector</em>对象，第二个参数定义了一个兴趣集**，**这意味着我们有兴趣通过选择器在受监控的通道中监听哪些事件。</p>
<p>我们可以监听四种不同的事件，每一种都由<em>SelectionKey</em>类中的一个常量表示：</p>
<ul>
<li><em>连接</em>-当客户端尝试连接到服务器时。由<em>SelectionKey.OP_CONNECT表示</em></li>
<li><em>接受</em>-当服务器接受来自客户端的连接时。由<em>SelectionKey.OP_ACCEPT表示</em></li>
<li><em>读取</em>-当服务器准备好从通道读取时。由<em>SelectionKey.OP_READ表示</em></li>
<li><em>写入</em>-当服务器准备好写入通道时。由<em>SelectionKey.OP_WRITE表示</em></li>
</ul>
<p>返回的对象<em>SelectionKey</em>表示可选通道向选择器的注册。我们将在下一节中进一步研究它。</p>
<h2 id="6-selectionkey对象"><strong>6. <em>SelectionKey</em>对象</strong></h2>
<p>正如我们在上一节中看到的，当我们使用选择器注册通道时，我们会得到一个<em>SelectionKey</em>对象。该对象保存表示通道注册的数据。</p>
<p>它包含一些重要的属性，我们必须很好地理解这些属性才能在通道上使用选择器。我们将在以下小节中介绍这些属性。</p>
<h3 id="61-interestset"><strong>6.1 interestSet</strong></h3>
<p>interestSet定义了我们希望选择器在此通道上注意的事件集。它是一个整数值；我们可以通过以下方式获取这些信息。</p>
<p>首先，我们有由<em>SelectionKey</em>的<em>interestOps</em>方法返回的interestSet。然后我们在前面看到的<em>SelectionKey</em>中有事件常量。</p>
<p>当我们 AND 这两个值时，我们得到一个布尔值，它告诉我们是否正在监视事件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">interestSet</span> <span class="o">=</span> <span class="n">selectionKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">boolean</span> <span class="n">isInterestedInAccept</span>  <span class="o">=</span> <span class="n">interestSet</span> <span class="o">&amp;</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">boolean</span> <span class="n">isInterestedInConnect</span> <span class="o">=</span> <span class="n">interestSet</span> <span class="o">&amp;</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_CONNECT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">boolean</span> <span class="n">isInterestedInRead</span>    <span class="o">=</span> <span class="n">interestSet</span> <span class="o">&amp;</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">boolean</span> <span class="n">isInterestedInWrite</span>   <span class="o">=</span> <span class="n">interestSet</span> <span class="o">&amp;</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_WRITE</span><span class="o">;</span>
</span></span></code></pre></div><h3 id="62-selectionkey"><strong>6.2. selectionKey</strong></h3>
<p>就绪集定义了通道准备就绪的事件集。它也是一个整数值；我们可以通过以下方式获取这些信息。</p>
<p>我们已经得到了<em>SelectionKey</em>的<em>readyOps</em>方法返回的就绪集。当我们像在兴趣集的情况下那样将此值与事件常量进行 AND 运算时，我们会得到一个布尔值，表示通道是否为特定值做好准备。</p>
<p>另一种更短的替代方法是使用<em>SelectionKey</em>的便捷方法来实现同样的目的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">selectionKey</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">selectionKey</span><span class="o">.</span><span class="na">isConnectable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">selectionKey</span><span class="o">.</span><span class="na">isReadable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">selectionKey</span><span class="o">.</span><span class="na">isWriteable</span><span class="o">();</span>
</span></span></code></pre></div><h3 id="63-channel"><strong>6.3. Channel</strong></h3>
<p><em>从SelectionKey</em>对象访问正在观看的频道非常简单。我们只是调用<em>通道</em>方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
</span></span></code></pre></div><h3 id="64-selector"><strong>6.4. Selector</strong></h3>
<p>就像获取频道一样，从<em>SelectionKey对象中获取**Selector</em>对象非常容易：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">selector</span><span class="o">();</span>
</span></span></code></pre></div><h3 id="65-附加对象"><strong>6.5 附加对象</strong></h3>
<p>我们可以将对象附加到*SelectionKey。*有时我们可能想要给一个频道一个自定义 ID 或附加我们可能想要跟踪的任何类型的 Java 对象。</p>
<p>附加对象是一种方便的方法。<em>以下是从SelectionKey</em>附加和获取对象的方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">key</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="n">Object</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">attachment</span><span class="o">();</span>
</span></span></code></pre></div><p>或者，我们可以选择在频道注册期间附加一个对象。我们将它作为第三个参数添加到通道的<em>register</em>方法中，如下所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">,</span> <span class="n">object</span><span class="o">);</span>
</span></span></code></pre></div><h2 id="7-频道键选择"><strong>7. 频道键选择</strong></h2>
<p>到目前为止，我们已经了解了如何创建选择器、向其注册通道并检查表示通道注册到选择器的<em>SelectionKey</em>对象的属性。</p>
<p>这只是过程的一半，现在我们必须执行一个连续的过程来选择我们之前看到的就绪集。我们使用选择器的<em>select</em>方法进行选择，如下所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
</span></span></code></pre></div><p>此方法会阻塞，直到至少一个通道准备好进行操作。返回的整数表示其通道已准备好进行操作的键的数量。</p>
<p>接下来，我们通常检索一组选定的键进行处理：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Set</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">selectedKeys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span>
</span></span></code></pre></div><p>我们得到的集合是<em>SelectionKey</em>对象，每个键代表一个已注册的通道，准备好进行操作。</p>
<p>在此之后，我们通常会遍历这个集合，并且对于每个键，我们获取通道并执行我们感兴趣的集合中出现的任何操作。</p>
<p>在通道的生命周期中，可能会多次选择它，因为它的键出现在不同事件的就绪集中。这就是为什么我们必须有一个连续的循环来在通道事件发生时捕获和处理它们。</p>
<h2 id="8-完整示例"><strong>8. 完整示例</strong></h2>
<p>为了巩固我们在前几节中获得的知识，我们将构建一个完整的客户端-服务器示例。</p>
<p>为了便于测试我们的代码，我们将构建一个回显服务器和一个回显客户端。在这种设置中，客户端连接到服务器并开始向它发送消息。服务器回显每个客户端发送的消息。</p>
<p>当服务器遇到特定消息时，例如<em>end</em>，它会将其解释为通信结束并关闭与客户端的连接。</p>
<h3 id="81-服务器"><strong>8.1 服务器</strong></h3>
<p>这是我们的<em>EchoServer.java</em>代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EchoServer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">POISON_PILL</span> <span class="o">=</span> <span class="s">&#34;POISON_PILL&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="n">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ServerSocketChannel</span> <span class="n">serverSocket</span> <span class="o">=</span> <span class="n">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">serverSocket</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="n">5454</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">serverSocket</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">serverSocket</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">256</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Set</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">selectedKeys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">selectedKeys</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">serverSocket</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">answerWithEcho</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">iter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">answerWithEcho</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">buffer</span><span class="o">,</span> <span class="n">SelectionKey</span> <span class="n">key</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">SocketChannel</span> <span class="n">client</span> <span class="o">=</span> <span class="o">(</span><span class="n">SocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">client</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">array</span><span class="o">()).</span><span class="na">trim</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">POISON_PILL</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">client</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Not accepting client messages anymore&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">client</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">Selector</span> <span class="n">selector</span><span class="o">,</span> <span class="n">ServerSocketChannel</span> <span class="n">serverSocket</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">SocketChannel</span> <span class="n">client</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">client</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">client</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Process</span> <span class="nf">start</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">javaHome</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;java.home&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">javaBin</span> <span class="o">=</span> <span class="n">javaHome</span> <span class="o">+</span> <span class="n">File</span><span class="o">.</span><span class="na">separator</span> <span class="o">+</span> <span class="s">&#34;bin&#34;</span> <span class="o">+</span> <span class="n">File</span><span class="o">.</span><span class="na">separator</span> <span class="o">+</span> <span class="s">&#34;java&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">classpath</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;java.class.path&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">EchoServer</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getCanonicalName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ProcessBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessBuilder</span><span class="o">(</span><span class="n">javaBin</span><span class="o">,</span> <span class="s">&#34;-cp&#34;</span><span class="o">,</span> <span class="n">classpath</span><span class="o">,</span> <span class="n">className</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>这就是正在发生的事情；我们通过调用静态<em>open</em>方法创建一个<em>Selector对象。<em>然后我们也通过调用它的静态</em>open</em>方法来创建一个通道，特别是一个<em>ServerSocketChannel</em>实例。</p>
<p>这是因为** <em>ServerSocketChannel</em>是可选择的并且适用于面向流的侦听套接字**。</p>
<p>然后我们将它绑定到我们选择的端口。还记得我们之前说过，在将可选通道注册到选择器之前，我们必须先将其设置为非阻塞模式。所以接下来我们这样做，然后将通道注册到选择器。</p>
<p>在这个阶段我们不需要这个通道的<em>SelectionKey</em>实例，所以我们不会记住它。</p>
<p>Java NIO 使用面向缓冲区的模型而不是面向流的模型。因此套接字通信通常通过写入和读取缓冲区来进行。</p>
<p>因此，我们创建了一个新的<em>ByteBuffer</em>，服务器将对其进行写入和读取。我们将其初始化为 256 字节，它只是一个任意值，取决于我们计划来回传输的数据量。</p>
<p>最后，我们执行选择过程。我们选择准备好的通道，检索它们的选择键，遍历键，并执行每个通道准备好的操作。</p>
<p>我们在无限循环中执行此操作，因为无论是否有活动，服务器通常都需要继续运行。</p>
<p><em>ServerSocketChannel</em>可以处理的唯一操作是<em>ACCEPT</em>操作。当我们接受来自客户端的连接时，我们会获得一个<em>SocketChannel</em>对象，我们可以在该对象上进行读写。我们将其设置为非阻塞模式并将其注册为对选择器的 READ 操作。</p>
<p>在随后的选择之一期间，该新通道将变为就绪状态。我们检索它并将其内容读入缓冲区。作为一个回显服务器，我们必须将此内容写回客户端。</p>
<p>*<em>当我们想要写入我们一直在读取的缓冲区时，我们必须调用*flip()<em>方法</em></em>。</p>
<p><em>我们最终通过调用翻转</em>方法将缓冲区设置为写入模式并简单地对其进行写入。</p>
<p>定义了*start()*方法，以便在单元测试期间可以将 echo 服务器作为单独的进程启动。</p>
<h3 id="82-客户端"><strong>8.2. 客户端</strong></h3>
<p>这是我们的<em>EchoClient.java</em>代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EchoClient</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">SocketChannel</span> <span class="n">client</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ByteBuffer</span> <span class="n">buffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">EchoClient</span> <span class="n">instance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">EchoClient</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EchoClient</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">client</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">buffer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">EchoClient</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">client</span> <span class="o">=</span> <span class="n">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="n">5454</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">256</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">sendMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">client</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">client</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">array</span><span class="o">()).</span><span class="na">trim</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;response=&#34;</span> <span class="o">+</span> <span class="n">response</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>客户端比服务器简单。</p>
<p>我们使用单例模式在<em>start</em>静态方法中实例化它。我们从此方法调用私有构造函数。</p>
<p>在私有构造函数中，我们在绑定服务器通道的同一端口上打开一个连接，并且仍然在同一主机上。</p>
<p>然后我们创建一个可以写入和读取的缓冲区。</p>
<p>最后，我们有一个<em>sendMessage</em>方法，它读取将我们传递给它的任何字符串包装到一个字节缓冲区中，该缓冲区通过通道传输到服务器。</p>
<p>然后我们从客户端通道中读取以获取服务器发送的消息。我们将其作为我们信息的回声返回。</p>
<h3 id="83-测试"><strong>8.3. 测试</strong></h3>
<p>在一个名为<em>EchoTest.java</em>的类中，我们将创建一个测试用例，它启动服务器，向服务器发送消息，并且只有在从服务器接收到相同的消息时才通过。作为最后一步，测试用例在完成之前停止服务器。</p>
<p>我们现在可以运行测试：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EchoTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Process</span> <span class="n">server</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">EchoClient</span> <span class="n">client</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Before</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span> <span class="o">=</span> <span class="n">EchoServer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">client</span> <span class="o">=</span> <span class="n">EchoClient</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">givenServerClient_whenServerEchosMessage_thenCorrect</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">resp1</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="s">&#34;hello&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">resp2</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="s">&#34;world&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">assertEquals</span><span class="o">(</span><span class="s">&#34;hello&#34;</span><span class="o">,</span> <span class="n">resp1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">assertEquals</span><span class="o">(</span><span class="s">&#34;world&#34;</span><span class="o">,</span> <span class="n">resp2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@After</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">teardown</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="o">.</span><span class="na">destroy</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">EchoClient</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="9-selectorwakeup">9. <em>selector.wakeup()</em></h2>
<p>正如我们之前看到的，调用*selector.select()<em>会阻塞当前线程，直到其中一个被监视的通道准备好运行。我们可以通过从另一个线程调用</em>selector.wakeup()*来覆盖它。</p>
<p>结果是<strong>阻塞线程立即返回而不是继续等待，无论通道是否已就绪</strong>。</p>
<p>我们可以使用*<a href="java-countdown-latch" rel="">CountDownLatch</a>*来演示这一点并跟踪代码执行步骤：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">whenWakeUpCalledOnSelector_thenBlockedThreadReturns</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Pipe</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipe</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="n">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">SelectableChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="na">source</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">channel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">channel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">OP_READ</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">invocationStepsTracker</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">CountDownLatch</span> <span class="n">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invocationStepsTracker</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;&gt;&gt; Count down&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">invocationStepsTracker</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;&gt;&gt; Start select&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">invocationStepsTracker</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;&gt;&gt; End select&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">invocationStepsTracker</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;&gt;&gt; Start await&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">latch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">invocationStepsTracker</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;&gt;&gt; End await&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">invocationStepsTracker</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;&gt;&gt; Wakeup thread&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">selector</span><span class="o">.</span><span class="na">wakeup</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//clean up
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">assertThat</span><span class="o">(</span><span class="n">invocationStepsTracker</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">containsExactly</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;&gt;&gt; Start await&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;&gt;&gt; Count down&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;&gt;&gt; Start select&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;&gt;&gt; End await&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;&gt;&gt; Wakeup thread&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;&gt;&gt; End select&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>在这个例子中，我们使用 Java NIO 的<em>Pipe</em>类来打开一个通道进行测试。我们在线程安全列表中跟踪代码执行步骤。通过分析这些步骤，我们可以看到*selector.wakeup()<em>是如何释放被</em>selector.select()*阻塞的线程的。
&quot;</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-07-26</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://itcodingman.github.io/java_nio_selector/" data-title="Java NIO 选择器简介" data-hashtags="Java IO,Java NIO"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://itcodingman.github.io/java_nio_selector/" data-hashtag="Java IO"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://itcodingman.github.io/java_nio_selector/" data-title="Java NIO 选择器简介"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://itcodingman.github.io/java_nio_selector/" data-title="Java NIO 选择器简介"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://itcodingman.github.io/java_nio_selector/" data-title="Java NIO 选择器简介"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/java-io/">Java IO</a>,&nbsp;<a href="/tags/java-nio/">Java NIO</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/java_nio2_path/" class="prev" rel="prev" title="Java NIO2 路径 API"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Java NIO2 路径 API</a>
            <a href="/java_nio2_async_file_channel/" class="next" rel="next" title="NIO2 异步文件通道指南">NIO2 异步文件通道指南<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">codingman</a></span></div>
        </div>
    </footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-XH3B2JPQ1K', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-XH3B2JPQ1K" async></script></body>
</html>
