<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Apache Mesos 指南 - Coding Man</title><meta name="Description" content="在本文中，我们简要讨论了在同一集群中运行的应用程序之间的资源共享。我们还讨论了 Apache Mesos 如何通过集群资源（如 CPU 和内存）的抽象视图帮助应用程序实现最大利用率。稍后，我们讨论了基于各种公平策略和角色的应用程序之间的资源动态分配。Mesos 允许应用程序根据集群中 Mesos 代理提供的资源做出调度决策。最后，我们看到了 Mesos 框架在 Java 中的实现。"><meta property="og:title" content="Apache Mesos 指南" />
<meta property="og:description" content="在本文中，我们简要讨论了在同一集群中运行的应用程序之间的资源共享。我们还讨论了 Apache Mesos 如何通过集群资源（如 CPU 和内存）的抽象视图帮助应用程序实现最大利用率。稍后，我们讨论了基于各种公平策略和角色的应用程序之间的资源动态分配。Mesos 允许应用程序根据集群中 Mesos 代理提供的资源做出调度决策。最后，我们看到了 Mesos 框架在 Java 中的实现。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://itcodingman.github.io/apache_mesos/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-05-22T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-07-25T00:00:00+00:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Apache Mesos 指南"/>
<meta name="twitter:description" content="在本文中，我们简要讨论了在同一集群中运行的应用程序之间的资源共享。我们还讨论了 Apache Mesos 如何通过集群资源（如 CPU 和内存）的抽象视图帮助应用程序实现最大利用率。稍后，我们讨论了基于各种公平策略和角色的应用程序之间的资源动态分配。Mesos 允许应用程序根据集群中 Mesos 代理提供的资源做出调度决策。最后，我们看到了 Mesos 框架在 Java 中的实现。"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2168947316195146"
     crossorigin="anonymous"></script><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://itcodingman.github.io/apache_mesos/" /><link rel="prev" href="http://itcodingman.github.io/apache_meecrowave/" /><link rel="next" href="http://itcodingman.github.io/apache_open_nlp/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Apache Mesos 指南",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/itcodingman.github.io\/apache_mesos\/"
        },"genre": "posts","wordcount":  4448 ,
        "url": "http:\/\/itcodingman.github.io\/apache_mesos\/","datePublished": "2018-05-22T00:00:00+00:00","dateModified": "2022-07-25T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "codingman"
            },"description": "在本文中，我们简要讨论了在同一集群中运行的应用程序之间的资源共享。我们还讨论了 Apache Mesos 如何通过集群资源（如 CPU 和内存）的抽象视图帮助应用程序实现最大利用率。稍后，我们讨论了基于各种公平策略和角色的应用程序之间的资源动态分配。Mesos 允许应用程序根据集群中 Mesos 代理提供的资源做出调度决策。最后，我们看到了 Mesos 框架在 Java 中的实现。"
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Coding Man"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/logo.jpg"
        data-srcset="/logo.jpg, /logo.jpg 1.5x, /logo.jpg 2x"
        data-sizes="auto"
        alt="/logo.jpg"
        title="/logo.jpg" />Coding Man</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 
										</a><a class="menu-item" href="/tags/"> 标签 
										</a><a class="menu-item" href="/categories/"> 分类 
										</a><a class="menu-item" href="/search/"><i class='fas fa-fw fa-search'></i> 搜索 
										</a>
										<div class="dropdown">
											<a href="javascript:void(0);" class="menu-item menu-more dropbtn" title="" > 链接 
											</a>
											<div class="menu-more-content dropdown-content"><a href="https://space.bilibili.com/499533333" title="" target="_blank" rel="noopener"> BiliBili </a><a href="https://www.youtube.com/c/itcodingman" title="" target="_blank" rel="noopener"> YouTube </a></div>
										</div>
									<span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Coding Man"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/logo.jpg"
        data-srcset="/logo.jpg, /logo.jpg 1.5x, /logo.jpg 2x"
        data-sizes="auto"
        alt="/logo.jpg"
        title="/logo.jpg" />Coding Man</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/"> 文章 
								</a><a class="menu-item" href="/tags/"> 标签 
								</a><a class="menu-item" href="/categories/"> 分类 
								</a><a class="menu-item" href="/search/"><i class='fas fa-fw fa-search'></i> 搜索 
								</a>
								<div class="dropdown">
									<a href="javascript:void(0);" class="menu-item menu-more dropbtn" title="" > 链接 
									</a>
									<div class="menu-more-content dropdown-content"><a href="https://space.bilibili.com/499533333" title="" target="_blank" rel="noopener"> BiliBili </a><a href="https://www.youtube.com/c/itcodingman" title="" target="_blank" rel="noopener"> YouTube </a></div>
								</div>
							<a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container">
                    <div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Apache Mesos 指南</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>codingman</a></span>&nbsp;<span class="post-category">included in <a href="/categories/architecture/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Architecture</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2018-05-22">2018-05-22</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;4448 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;9 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-概述">1. 概述</a></li>
    <li><a href="#2-共享集群">2. 共享集群</a></li>
    <li><a href="#3-apache-mesos">3. Apache Mesos</a>
      <ul>
        <li><a href="#31-mesos-大师">3.1 Mesos 大师</a></li>
        <li><a href="#32-mesos-代理">3.2. Mesos 代理</a></li>
        <li><a href="#33-中观框架">3.3. 中观框架</a></li>
      </ul>
    </li>
    <li><a href="#4-资源管理">4. 资源管理</a>
      <ul>
        <li><a href="#41-资源优惠">4.1 资源优惠</a></li>
        <li><a href="#42-资源角色">4.2. 资源角色</a></li>
        <li><a href="#43-资源预留">4.3. 资源预留</a></li>
        <li><a href="#44-资源权重和配额">4.4. 资源权重和配额</a></li>
      </ul>
    </li>
    <li><a href="#5-实施框架">5. 实施框架</a>
      <ul>
        <li><a href="#51-框架主类">5.1 框架主类</a></li>
        <li><a href="#52-实现调度器">5.2. 实现调度器</a></li>
        <li><a href="#53-执行者">5.3. 执行者</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="1-概述">1. 概述</h2>
<p>我们通常在同一个机器集群上部署各种应用程序。例如，现在很常见的是 在同一个集群中拥有像<a href="/apache-spark" rel="">Apache Spark</a>或<a href="/apache-flink" rel="">Apache Flink这样的分布式处理引擎和像</a><a href="/cassandra-with-java" rel="">Apache Cassandra</a>这样的分布式数据库。</p>
<p><strong>Apache Mesos 是一个允许此类应用程序之间有效资源共享的平台。</strong></p>
<p>在本文中，我们将首先讨论部署在同一集群上的应用程序中的资源分配问题。稍后，我们将看到 Apache Mesos 如何在应用程序之间提供更好的资源利用率。</p>
<h2 id="2-共享集群">2. 共享集群</h2>
<p>许多应用程序需要共享一个集群。总的来说，有两种常见的方法：</p>
<ul>
<li>静态分区集群并在每个分区上运行应用程序</li>
<li>将一组机器分配给一个应用程序</li>
</ul>
<p>尽管这些方法允许应用程序彼此独立运行，但它并没有实现高资源利用率。</p>
<p>例如，考虑一个应用程序，<strong>它只运行了很短的时间，然后是一段时间的不活动。<strong>现在，由于我们为该应用程序分配了静态机器或分区，因此</strong>在非活动期间我们有未使用的资源。</strong></p>
<p>我们可以通过将非活动期间的空闲资源重新分配给其他应用程序来优化资源利用率。</p>
<p>Apache Mesos 有助于在应用程序之间进行动态资源分配。</p>
<h2 id="3-apache-mesos">3. Apache Mesos</h2>
<p>使用我们上面讨论的两种集群共享方法，应用程序只知道它们正在运行的特定分区或机器的资源。但是，Apache Mesos 为应用程序提供了集群中所有资源的抽象视图。</p>
<p>我们很快就会看到，Mesos 充当机器和应用程序之间的接口。它为应用程序提供**集群中所有机器上的可用资源。<strong>它经常更新此信息以包括由已达到完成状态</strong>的应用程序释放的资源。**这允许应用程序就在哪台机器上执行哪个任务做出最佳决定。</p>
<p>为了理解 Mesos 是如何工作的，让我们来看看它的<a href="https://mesos.apache.org/documentation/latest/architecture/" target="_blank" rel="noopener noreffer">架构</a>：</p>
<p><a href="wp-content/uploads/2019/07/Mesos-arch.jpg" rel=""><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="wp-content/uploads/2019/07/Mesos-arch.jpg"
        data-srcset="wp-content/uploads/2019/07/Mesos-arch.jpg, wp-content/uploads/2019/07/Mesos-arch.jpg 1.5x, wp-content/uploads/2019/07/Mesos-arch.jpg 2x"
        data-sizes="auto"
        alt="wp-content/uploads/2019/07/Mesos-arch.jpg"
        title="wp-content/uploads/2019/07/Mesos-arch.jpg" /></a>
此图像是 Mesos 官方文档的一部分（<a href="https://mesos.apache.org/assets/img/documentation/architecture3.jpg" target="_blank" rel="noopener noreffer">来源</a>）。在这里，<em>Hadoop</em>和<em>MPI</em>是共享集群的两个应用程序。</p>
<p>我们将在接下来的几节中讨论此处显示的每个组件。</p>
<h3 id="31-mesos-大师">3.1 Mesos 大师</h3>
<p>Master 是此设置中的核心组件，用于存储集群中资源的当前状态。此外，它通过传递有关资源和任务等信息，充当<strong>代理和应用程序之间的协调器。</strong></p>
<p>由于 master 中的任何故障都会导致有关资源和任务的状态丢失，因此我们将其部署在高可用性配置中。从上图中可以看出，Mesos 部署了备用主守护进程和一个领导者。这些守护进程依靠 Zookeeper 来在发生故障时恢复状态。</p>
<h3 id="32-mesos-代理">3.2. Mesos 代理</h3>
<p>Mesos 集群必须在每台机器上运行一个代理。这些代理<strong>会定期向主服务器报告它们的资源，<strong>并依次</strong>接收应用程序已安排运行的任务</strong>。此循环在计划任务完成或丢失后重复。</p>
<p>我们将在以下部分中了解应用程序如何在这些代理上调度和执行任务。</p>
<h3 id="33-中观框架">3.3. 中观框架</h3>
<p>Mesos 允许应用程序实现一个抽象组件，该组件与 Master 交互以**接收集群中的可用资源，<strong>并根据它们</strong>做出调度决策。**这些组件称为框架。</p>
<p>一个 Mesos 框架由两个子组件组成：</p>
<ul>
<li><em>调度程序</em>- 使应用程序能够根据所有代理上的可用资源来调度任务</li>
<li><em>Executor</em> – 在所有代理上运行，并包含在该代理上执行任何计划任务所需的所有信息</li>
</ul>
<p>这个流程描述了整个过程：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="wp-content/uploads/2019/07/Mesos-flow.jpg"
        data-srcset="wp-content/uploads/2019/07/Mesos-flow.jpg, wp-content/uploads/2019/07/Mesos-flow.jpg 1.5x, wp-content/uploads/2019/07/Mesos-flow.jpg 2x"
        data-sizes="auto"
        alt="wp-content/uploads/2019/07/Mesos-flow.jpg"
        title="wp-content/uploads/2019/07/Mesos-flow.jpg" /></p>
<p>首先，代理向主报告他们的资源。此时，master 将这些资源提供给所有已注册的调度程序。此过程称为资源提供，我们将在下一节中详细讨论。</p>
<p>然后调度程序选择最好的代理并通过 Master 在其上执行各种任务。一旦执行者完成分配的任务，代理就会重新将他们的资源发布给主节点。Master 对集群中的所有框架重复这个资源共享过程。</p>
<p>Mesos 允许应用程序以各种编程语言<strong>实现其自定义调度程序和执行程序。调度程序的</strong>Java 实现必须<strong>实现<em>调度程序</em>接口</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldScheduler</span> <span class="kd">implements</span> <span class="n">Scheduler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registered</span><span class="o">(</span><span class="n">SchedulerDriver</span> <span class="n">schedulerDriver</span><span class="o">,</span> <span class="n">Protos</span><span class="o">.</span><span class="na">FrameworkID</span> <span class="n">frameworkID</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">      <span class="n">Protos</span><span class="o">.</span><span class="na">MasterInfo</span> <span class="n">masterInfo</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reregistered</span><span class="o">(</span><span class="n">SchedulerDriver</span> <span class="n">schedulerDriver</span><span class="o">,</span> <span class="n">Protos</span><span class="o">.</span><span class="na">MasterInfo</span> <span class="n">masterInfo</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">resourceOffers</span><span class="o">(</span><span class="n">SchedulerDriver</span> <span class="n">schedulerDriver</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Offer</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">offerRescinded</span><span class="o">(</span><span class="n">SchedulerDriver</span> <span class="n">schedulerDriver</span><span class="o">,</span> <span class="n">OfferID</span> <span class="n">offerID</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">statusUpdate</span><span class="o">(</span><span class="n">SchedulerDriver</span> <span class="n">schedulerDriver</span><span class="o">,</span> <span class="n">Protos</span><span class="o">.</span><span class="na">TaskStatus</span> <span class="n">taskStatus</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">frameworkMessage</span><span class="o">(</span><span class="n">SchedulerDriver</span> <span class="n">schedulerDriver</span><span class="o">,</span> <span class="n">Protos</span><span class="o">.</span><span class="na">ExecutorID</span> <span class="n">executorID</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">      <span class="n">Protos</span><span class="o">.</span><span class="na">SlaveID</span> <span class="n">slaveID</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">disconnected</span><span class="o">(</span><span class="n">SchedulerDriver</span> <span class="n">schedulerDriver</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">slaveLost</span><span class="o">(</span><span class="n">SchedulerDriver</span> <span class="n">schedulerDriver</span><span class="o">,</span> <span class="n">Protos</span><span class="o">.</span><span class="na">SlaveID</span> <span class="n">slaveID</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">executorLost</span><span class="o">(</span><span class="n">SchedulerDriver</span> <span class="n">schedulerDriver</span><span class="o">,</span> <span class="n">Protos</span><span class="o">.</span><span class="na">ExecutorID</span> <span class="n">executorID</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">      <span class="n">Protos</span><span class="o">.</span><span class="na">SlaveID</span> <span class="n">slaveID</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">error</span><span class="o">(</span><span class="n">SchedulerDriver</span> <span class="n">schedulerDriver</span><span class="o">,</span> <span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>可以看出，它主要由<strong>各种回调方法组成，特别是用于与主设备通信</strong>。</p>
<p>同样，执行器的实现必须实现<em>Executor</em>接口：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldExecutor</span> <span class="kd">implements</span> <span class="n">Executor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registered</span><span class="o">(</span><span class="n">ExecutorDriver</span> <span class="n">driver</span><span class="o">,</span> <span class="n">Protos</span><span class="o">.</span><span class="na">ExecutorInfo</span> <span class="n">executorInfo</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">      <span class="n">Protos</span><span class="o">.</span><span class="na">FrameworkInfo</span> <span class="n">frameworkInfo</span><span class="o">,</span> <span class="n">Protos</span><span class="o">.</span><span class="na">SlaveInfo</span> <span class="n">slaveInfo</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reregistered</span><span class="o">(</span><span class="n">ExecutorDriver</span> <span class="n">driver</span><span class="o">,</span> <span class="n">Protos</span><span class="o">.</span><span class="na">SlaveInfo</span> <span class="n">slaveInfo</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">disconnected</span><span class="o">(</span><span class="n">ExecutorDriver</span> <span class="n">driver</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">launchTask</span><span class="o">(</span><span class="n">ExecutorDriver</span> <span class="n">driver</span><span class="o">,</span> <span class="n">Protos</span><span class="o">.</span><span class="na">TaskInfo</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">killTask</span><span class="o">(</span><span class="n">ExecutorDriver</span> <span class="n">driver</span><span class="o">,</span> <span class="n">Protos</span><span class="o">.</span><span class="na">TaskID</span> <span class="n">taskId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">frameworkMessage</span><span class="o">(</span><span class="n">ExecutorDriver</span> <span class="n">driver</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">(</span><span class="n">ExecutorDriver</span> <span class="n">driver</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>我们将在后面的部分中看到调度器和执行器的操作版本。</p>
<h2 id="4-资源管理">4. 资源管理</h2>
<h3 id="41-资源优惠">4.1 资源优惠</h3>
<p>正如我们之前所讨论的，代理将其资源信息发布给主节点。反过来，主节点将这些资源提供给集群中运行的框架。此过程称为<em>资源报价。</em></p>
<p>资源报价由两部分组成——资源和属性。</p>
<p>资源用于<strong>发布代理机器</strong>的内存、CPU、磁盘等硬件信息。</p>
<p>每个代理都有五种预定义资源：</p>
<ul>
<li><em>中央处理器</em></li>
<li><em>显卡</em></li>
<li><em>内存</em></li>
<li><em>磁盘</em></li>
<li><em>港口</em></li>
</ul>
<p>这些资源的值可以定义为以下三种类型之一：</p>
<ul>
<li><em>标量</em>- 用于使用浮点数表示数字信息以允许小数值，例如 1.5G 内存</li>
<li><em>范围</em>——用于表示标量值的范围——例如，端口范围</li>
<li><em>Set</em> – 用于表示多个文本值</li>
</ul>
<p>默认情况下，Mesos 代理会尝试从机器上检测这些资源。</p>
<p>但是，在某些情况下，我们可以在代理上配置自定义资源。此类自定义资源的值应再次采用上述任何一种类型。</p>
<p>例如，我们可以使用以下资源启动我们的代理：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">--resources=&#39;cpus:24;gpus:2;mem:24576;disk:409600;ports:[21000-24000,30000-34000];bugs(debug_role):{a,b,c}&#39;
</span></span></code></pre></div><p>可以看出，我们已经为代理配置了一些预定义资源和一个名为<em>bugs</em>的自定义资源，它是 <em>集合</em>类型。</p>
<p>除了资源之外，代理还可以向主服务器发布键值属性。这些属性充当代理的附加元数据，并帮助框架进行调度决策。</p>
<p>一个有用的示例可以是<strong>将代理添加到不同的机架或区域</strong>，然后<strong>在同一机架或区域上安排各种任务</strong>以实现数据本地化：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">--attributes=&#39;rack:abc;zone:west;os:centos5;level:10;keys:[1000-1500]&#39;
</span></span></code></pre></div><p>与资源类似，属性值可以是标量、范围或文本类型。</p>
<h3 id="42-资源角色">4.2. 资源角色</h3>
<p>许多现代操作系统支持多个用户。同样，Mesos 也支持同一个集群中的多个用户。这些用户称为<em>角色</em>。我们可以将每个角色视为集群中的资源消费者。</p>
<p>因此，Mesos 代理可以根据不同的分配策略对不同角色下的资源进行划分。此外，框架可以在集群中订阅这些角色，并对不同角色下的资源进行细粒度控制。</p>
<p>例如，考虑一个<strong>集群托管应用程序，这些应用程序为组织中的不同用户提供服务</strong>。因此，通过<strong>将资源划分为角色，每个应用程序都可以</strong>彼此隔离工作。</p>
<p>此外，框架可以使用这些角色来实现数据局部性。</p>
<p>例如，假设我们在集群中有两个应用程序，名为<em>生产者</em>和 <em>消费者。<em>在这里， <em>生产者</em>将数据写入一个持久卷， <em>消费者</em>随后可以读取该卷。我们可以 通过与</em>生产者</em>共享卷 来优化<em>消费者 应用程序。</em></p>
<p>由于 Mesos 允许多个应用程序订阅同一个角色，我们可以将持久卷与资源角色相关联。<em>此外，生产者</em>和 <em>消费者</em>的框架都将订阅相同的资源角色。因此，<em>消费者</em>应用程序现在可以在与<em>生产者</em>应用程序<strong>相同的卷上</strong>启动数据读取任务。</p>
<h3 id="43-资源预留">4.3. 资源预留</h3>
<p>现在可能会出现关于 Mesos 如何将集群资源分配给不同角色的问题。Mesos 通过预留分配资源。</p>
<p>有两种类型的预订：</p>
<ul>
<li>静态预留</li>
<li>动态预订</li>
</ul>
<p>静态预留类似于我们在前面部分讨论的代理启动时的资源分配：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl"> --resources=&#34;cpus:4;mem:2048;cpus(Demo):8;mem(Demo):4096&#34;
</span></span></code></pre></div><p>这里唯一的区别是，现在 Mesos 代理为名为<em><strong>Demo</strong></em><strong>的角色保留了 8 个 CPU 和 4096m 内存。</strong></p>
<p>与静态预留不同，动态预留允许我们重新调整角色内的资源。Mesos 允许框架和集群操作员通过框架消息作为对资源提供的响应或通过<a href="https://mesos.apache.org/documentation/latest/reservation/#examples" target="_blank" rel="noopener noreffer">HTTP 端点</a>动态更改资源分配。</p>
<p>Mesos 将所有没有任何角色的资源分配给一个名为 (*) 的默认角色。Master 向所有框架提供此类资源，无论它们是否订阅。</p>
<h3 id="44-资源权重和配额">4.4. 资源权重和配额</h3>
<p>通常，Mesos 主节点使用公平策略提供资源。它使用加权的优势资源公平 (wDRF) 来识别缺乏资源的角色。然后，master 向订阅了这些角色的框架提供更多资源。</p>
<p>尽管在应用程序之间公平共享资源是 Mesos 的一个重要特性，但它并不总是必要的。假设一个集群托管具有低资源占用的应用程序以及具有高资源需求的应用程序。在此类部署中，我们希望根据应用程序的性质分配资源。</p>
<p>Mesos 允许框架**通过订阅角色并为该角色添加更高的权重值来要求更多资源。**因此，<strong>如果有两个角色，一个是权重 1，另一个是权重 2，Mesos 会将两倍的公平资源分配给第二个角色。</strong></p>
<p>与资源类似，我们可以通过<a href="https://mesos.apache.org/documentation/latest/weights/#operator-http-endpoint" target="_blank" rel="noopener noreffer">HTTP 端点</a>配置权重。</p>
<p>除了确保为具有权重的角色分配公平的资源外，Mesos 还确保<strong>为角色分配最少的资源。</strong></p>
<p>Mesos 允许我们为<strong>资源角色添加配额。<strong>配额指定</strong>角色可以保证接收的最小资源量</strong>。</p>
<h2 id="5-实施框架">5. 实施框架</h2>
<p>正如我们在前面部分中讨论的，Mesos 允许应用程序以他们选择的语言提供框架实现。在 Java 中，使用主类（作为框架进程的入口点）以及前面讨论的<em>调度</em>器和 <em>执行器 的实现来实现框架。</em></p>
<h3 id="51-框架主类">5.1 框架主类</h3>
<p>在我们实现调度器和执行器之前，我们将首先实现我们框架的入口点：</p>
<ul>
<li>向主人注册自己</li>
<li>向代理提供执行程序运行时信息</li>
<li>启动调度程序</li>
</ul>
<p>我们将首先为 Mesos添加一个<a href="https://search.maven.org/search?q=g:org.apache.mesos%20AND%20a:mesos&amp;core=gav" target="_blank" rel="noopener noreffer">Maven 依赖项：</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.apache.mesos<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>mesos<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>0.28.3<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>接下来，我们将为我们的框架实现 <em>HelloWorldMain</em>。我们要做的第一件事是在 Mesos 代理上启动执行器进程：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;user.dir&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">+</span> <span class="s">&#34;/target/libraries2-1.0.0-SNAPSHOT.jar&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">CommandInfo</span><span class="o">.</span><span class="na">URI</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">CommandInfo</span><span class="o">.</span><span class="na">URI</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">setValue</span><span class="o">(</span><span class="n">path</span><span class="o">).</span><span class="na">setExtract</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">helloWorldCommand</span> <span class="o">=</span> <span class="s">&#34;java -cp libraries2-1.0.0-SNAPSHOT.jar com.codingman.mesos.executors.HelloWorldExecutor&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">CommandInfo</span> <span class="n">commandInfoHelloWorld</span> <span class="o">=</span> <span class="n">CommandInfo</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">helloWorldCommand</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">addUris</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">ExecutorInfo</span> <span class="n">executorHelloWorld</span> <span class="o">=</span> <span class="n">ExecutorInfo</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">setExecutorId</span><span class="o">(</span><span class="n">Protos</span><span class="o">.</span><span class="na">ExecutorID</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="s">&#34;HelloWorldExecutor&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">setCommand</span><span class="o">(</span><span class="n">commandInfoHelloWorld</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;Hello World (Java)&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="s">&#34;java&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>在这里，我们首先配置了执行器二进制位置。Mesos 代理将在框架注册时下载此二进制文件。接下来，代理将运行给定的命令来启动执行程序进程。</p>
<p>接下来，我们将初始化我们的框架并启动调度程序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">FrameworkInfo</span><span class="o">.</span><span class="na">Builder</span> <span class="n">frameworkBuilder</span> <span class="o">=</span> <span class="n">FrameworkInfo</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">setFailoverTimeout</span><span class="o">(</span><span class="n">120000</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">setUser</span><span class="o">(</span><span class="s">&#34;&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;Hello World Framework (Java)&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">frameworkBuilder</span><span class="o">.</span><span class="na">setPrincipal</span><span class="o">(</span><span class="s">&#34;test-framework-java&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">MesosSchedulerDriver</span> <span class="n">driver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MesosSchedulerDriver</span><span class="o">(</span><span class="k">new</span> <span class="n">HelloWorldScheduler</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">  <span class="n">frameworkBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(),</span> <span class="n">args</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
</span></span></code></pre></div><p>最后，**我们将启动向 Master 注册自身的<em>MesosSchedulerDriver</em>。为了成功注册，我们必须将 Master 的 IP 作为程序参数 <em>args[0]<em>传递给这个主类：</em></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">run</span><span class="o">()</span> <span class="o">==</span> <span class="n">Protos</span><span class="o">.</span><span class="na">Status</span><span class="o">.</span><span class="na">DRIVER_STOPPED</span> <span class="o">?</span> <span class="n">0</span> <span class="o">:</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">driver</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
</span></span></code></pre></div><p>在上面显示的类中，  <em>CommandInfo、ExecutorInfo</em> 和<em>FrameworkInfo</em>都是master 和框架之间的<a href="google-protocol-buffer" rel="">protobuf 消息的 Java 表示。</a></p>
<h3 id="52-实现调度器">5.2. 实现调度器</h3>
<p>从 Mesos 1.0 开始，<strong>我们可以从任何 Java 应用程序调用<a href="https://mesos.apache.org/documentation/latest/scheduler-http-api/" target="_blank" rel="noopener noreffer">HTTP 端点</a>来向 Mesos 主机发送和接收消息</strong>。其中一些消息包括，例如，框架注册、资源报价和报价拒绝。</p>
<p>对于<strong>Mesos 0.28 或更早版本，我们需要实现<em>Scheduler</em>接口</strong>：</p>
<p>在大多数情况下，我们将只关注 <em>调度程序的**resourceOffers</em>方法 。让我们看看调度程序如何接收资源并根据它们初始化任务。</p>
<p>首先，我们将了解调度程序如何为任务分配资源：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">resourceOffers</span><span class="o">(</span><span class="n">SchedulerDriver</span> <span class="n">schedulerDriver</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Offer</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">Offer</span> <span class="n">offer</span> <span class="o">:</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">TaskInfo</span><span class="o">&gt;</span> <span class="n">tasks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">TaskInfo</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Protos</span><span class="o">.</span><span class="na">TaskID</span> <span class="n">taskId</span> <span class="o">=</span> <span class="n">Protos</span><span class="o">.</span><span class="na">TaskID</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">launchedTasks</span><span class="o">++)).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Launching printHelloWorld &#34;</span> <span class="o">+</span> <span class="n">taskId</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; Hello World Java&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Protos</span><span class="o">.</span><span class="na">Resource</span><span class="o">.</span><span class="na">Builder</span> <span class="n">cpus</span> <span class="o">=</span> <span class="n">Protos</span><span class="o">.</span><span class="na">Resource</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;cpus&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="n">Protos</span><span class="o">.</span><span class="na">Value</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">SCALAR</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">setScalar</span><span class="o">(</span><span class="n">Protos</span><span class="o">.</span><span class="na">Value</span><span class="o">.</span><span class="na">Scalar</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Protos</span><span class="o">.</span><span class="na">Resource</span><span class="o">.</span><span class="na">Builder</span> <span class="n">mem</span> <span class="o">=</span> <span class="n">Protos</span><span class="o">.</span><span class="na">Resource</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;mem&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="n">Protos</span><span class="o">.</span><span class="na">Value</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">SCALAR</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">setScalar</span><span class="o">(</span><span class="n">Protos</span><span class="o">.</span><span class="na">Value</span><span class="o">.</span><span class="na">Scalar</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">128</span><span class="o">));</span>
</span></span></code></pre></div><p>在这里，我们为我们的任务分配了 1 个 CPU 和 128M 内存。接下来，我们将使用<em>SchedulerDriver</em>在代理上启动任务：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">        <span class="n">TaskInfo</span> <span class="n">printHelloWorld</span> <span class="o">=</span> <span class="n">TaskInfo</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;printHelloWorld &#34;</span> <span class="o">+</span> <span class="n">taskId</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">setTaskId</span><span class="o">(</span><span class="n">taskId</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">setSlaveId</span><span class="o">(</span><span class="n">offer</span><span class="o">.</span><span class="na">getSlaveId</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">addResources</span><span class="o">(</span><span class="n">cpus</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">addResources</span><span class="o">(</span><span class="n">mem</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">setExecutor</span><span class="o">(</span><span class="n">ExecutorInfo</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">(</span><span class="n">helloWorldExecutor</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">OfferID</span><span class="o">&gt;</span> <span class="n">offerIDS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">offerIDS</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">offer</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">tasks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">printHelloWorld</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">schedulerDriver</span><span class="o">.</span><span class="na">launchTasks</span><span class="o">(</span><span class="n">offerIDS</span><span class="o">,</span> <span class="n">tasks</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>或者， <em>调度程序</em>经常发现需要拒绝资源提供。例如，如果 <em>调度程序</em>由于缺乏资源而无法在代理上启动任务，它必须立即拒绝该提议：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">schedulerDriver</span><span class="o">.</span><span class="na">declineOffer</span><span class="o">(</span><span class="n">offer</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
</span></span></code></pre></div><h3 id="53-执行者">5.3. 执行者</h3>
<p>正如我们前面所讨论的，框架的执行器组件负责在 Mesos 代理上执行应用程序任务。</p>
<p>我们使用 HTTP 端点在 Mesos 1.0中实现*调度程序。*同样，我们可以将<a href="https://mesos.apache.org/documentation/latest/executor-http-api/" target="_blank" rel="noopener noreffer">HTTP 端点</a>用于执行程序。</p>
<p>在前面的部分中，我们讨论了框架如何配置代理以启动执行程序进程：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">java -cp libraries2-1.0.0-SNAPSHOT.jar com.codingman.mesos.executors.HelloWorldExecutor
</span></span></code></pre></div><p>值得注意的是，<strong>此命令将 <em>HelloWorldExecutor</em>视为主类。<strong>我们将实现这个<em>main</em>方法来</strong>初始化与 Mesos 代理连接的<em>MesosExecutorDriver</em></strong>以接收任务并共享其他信息，例如任务状态：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldExecutor</span> <span class="kd">implements</span> <span class="n">Executor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MesosExecutorDriver</span> <span class="n">driver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MesosExecutorDriver</span><span class="o">(</span><span class="k">new</span> <span class="n">HelloWorldExecutor</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">driver</span><span class="o">.</span><span class="na">run</span><span class="o">()</span> <span class="o">==</span> <span class="n">Protos</span><span class="o">.</span><span class="na">Status</span><span class="o">.</span><span class="na">DRIVER_STOPPED</span> <span class="o">?</span> <span class="n">0</span> <span class="o">:</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>现在要做的最后一件事是接受来自框架的任务并在代理上启动它们。启动任何任务的信息都包含在<em>HelloWorldExecutor 中：</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">launchTask</span><span class="o">(</span><span class="n">ExecutorDriver</span> <span class="n">driver</span><span class="o">,</span> <span class="n">TaskInfo</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Protos</span><span class="o">.</span><span class="na">TaskStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">Protos</span><span class="o">.</span><span class="na">TaskStatus</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">setTaskId</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getTaskId</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">setState</span><span class="o">(</span><span class="n">Protos</span><span class="o">.</span><span class="na">TaskState</span><span class="o">.</span><span class="na">TASK_RUNNING</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">driver</span><span class="o">.</span><span class="na">sendStatusUpdate</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Execute Task!!!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">status</span> <span class="o">=</span> <span class="n">Protos</span><span class="o">.</span><span class="na">TaskStatus</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">setTaskId</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getTaskId</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">setState</span><span class="o">(</span><span class="n">Protos</span><span class="o">.</span><span class="na">TaskState</span><span class="o">.</span><span class="na">TASK_FINISHED</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">driver</span><span class="o">.</span><span class="na">sendStatusUpdate</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>当然，这只是一个简单的实现，但它解释了 executor 如何在每个阶段与 master 共享任务状态，然后在发送完成状态之前执行任务。</p>
<p>在某些情况下，执行器还可以将数据发送回调度器：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span> <span class="n">myStatus</span> <span class="o">=</span> <span class="s">&#34;Hello Framework&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="n">driver</span><span class="o">.</span><span class="na">sendFrameworkMessage</span><span class="o">(</span><span class="n">myStatus</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
</span></span></code></pre></div><p>&quot;</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-07-25</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://itcodingman.github.io/apache_mesos/" data-title="Apache Mesos 指南"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://itcodingman.github.io/apache_mesos/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://itcodingman.github.io/apache_mesos/" data-title="Apache Mesos 指南"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://itcodingman.github.io/apache_mesos/" data-title="Apache Mesos 指南"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://itcodingman.github.io/apache_mesos/" data-title="Apache Mesos 指南"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/apache_meecrowave/" class="prev" rel="prev" title="使用 Apache Meecrowave 构建微服务"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>使用 Apache Meecrowave 构建微服务</a>
            <a href="/apache_open_nlp/" class="next" rel="next" title="Apache OpenNLP 简介">Apache OpenNLP 简介<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">codingman</a></span></div>
        </div>
    </footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-XH3B2JPQ1K', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-XH3B2JPQ1K" async></script></body>
</html>
